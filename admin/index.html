<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BUMABLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .admin-header {
            background: #000000;
            color: white;
            padding: 0.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
        }

        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .admin-nav a:hover,
        .admin-nav a.active {
            background: #333333;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 2rem;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-card.orders { color: #ff6b6b; }
        .stat-card.revenue { color: #28a745; }
        .stat-card.customers { color: #fd7e14; }
        .stat-card.products { color: #6f42c1; }

        .admin-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #000000;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .section-content {
            padding: 1.5rem;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        /* Ensure table container doesn't cut off dropdowns */
        .table-container {
            overflow: visible;
            position: relative;
        }

        .orders-table tbody tr {
            position: relative;
        }

        /* ===== POPUP MODAL STYLES ===== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .popup-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .popup-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        .popup-header {
            background: #097969;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .popup-body {
            padding: 25px;
        }

        .popup-body p {
            margin-bottom: 15px;
            color: #555;
        }

        .status-options {
            margin-top: 25px;
        }

        .status-options label {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-option:hover {
            border-color: #097969;
            background: #f8fff8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(9, 121, 105, 0.2);
        }

        .status-option i {
            font-size: 1.2rem;
            color: #097969;
        }

        .status-option.status-danger {
            border-color: #dc3545;
        }

        .status-option.status-danger:hover {
            border-color: #dc3545;
            background: #fff5f5;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        .status-option.status-danger i {
            color: #dc3545;
        }

        .popup-footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: right;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-primary {
            background: #097969;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #075d54;
        }

        .selected-status {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #097969;
        }

        .status-option.selected {
            border-color: #097969;
            background: #f8fff8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(9, 121, 105, 0.2);
        }

        /* ===== TAB SYSTEM ===== */
        .customer-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #097969;
        }

        .tab-btn.active {
            color: #097969;
            font-weight: 600;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #097969;
            border-radius: 2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== CONTACT QUERIES ===== */
        .query-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        .query-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .query-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .query-info h4 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
        }

        .query-info p {
            margin: 0.25rem 0 0 0;
            color: #666;
            font-size: 0.9rem;
        }

        .query-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-new { color: #ff6b6b; }
        .status-replied { color: #28a745; }

        .query-body {
            padding: 1.5rem;
        }

        .query-message {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #097969;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .query-reply {
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin-top: 1rem;
        }

        .query-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-confirmed { background: #d4edda; color: #155724; }
        .status-processing { background: #fff3cd; color: #856404; }
        .status-shipped { background: #cce5ff; color: #004085; }
        .status-delivered { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-right: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary { background: #ff6b6b; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Dropdown Actions */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .dropdown-toggle:hover {
            background: #5a6268;
        }

        .dropdown-toggle.btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .dropdown-toggle.btn-warning:hover {
            background: #e0a800;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 9999;
            display: none;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #097969;
        }

        .dropdown-item i {
            font-size: 0.85rem;
            width: 16px;
        }

        .dropdown-item.text-danger {
            color: #dc3545;
        }

        .dropdown-item.text-danger:hover {
            background: #fff5f5;
            color: #dc3545;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .no-orders {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .admin-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .admin-nav {
                justify-content: center;
                flex-wrap: wrap;
            }

            .admin-container {
                padding: 1rem;
            }

            .stats-grid {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }

            .orders-table {
                font-size: 0.8rem;
            }

            .filters {
                flex-direction: column;
            }
        }

        .customer-info {
            font-size: 0.85rem;
            color: #666;
        }

        .order-total {
            font-weight: 600;
            color: #28a745;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #ff6b6b;
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .modal-body {
            padding: 20px;
        }

        /* Order Summary Styles */
        .order-summary {
            font-family: 'Poppins', sans-serif;
        }

        .order-summary-header {
            text-align: center;
            border-bottom: 2px solid #097969;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .order-summary-header h2 {
            color: #097969;
            margin: 0;
            font-size: 24px;
        }

        .order-summary-header .company-info {
            margin-top: 5px;
            color: #666;
            font-size: 14px;
        }

        .summary-section {
            margin-bottom: 20px;
        }

        .summary-section h3 {
            color: #097969;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
        }

        .summary-row.total {
            border-top: 1px solid #ddd;
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 10px;
        }

        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .order-items-table th,
        .order-items-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .order-items-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #097969;
        }

        .download-pdf-btn {
            background: #097969;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-size: 16px;
        }

        .download-pdf-btn:hover {
            background: #075f52;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.25);
        }

        /* Website Layout Management Styles */
        .layout-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .layout-section h3 {
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .layout-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .layout-form .form-group {
            margin-bottom: 1rem;
        }

        .layout-form .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .layout-form input,
        .layout-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .layout-form input:focus,
        .layout-form textarea:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .upload-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #218838;
        }

        .image-preview-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .preview-container {
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 0.5rem;
        }

        .instagram-preview {
            height: 150px;
            width: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .instagram-post-editor {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #f8f9fa;
        }

        .instagram-post-editor h4 {
            color: #495057;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .preview-actions .action-btn {
            flex: 1;
        }

        /* Responsive layout for mobile */
        @media (max-width: 768px) {
            .layout-form .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .image-preview-row {
                grid-template-columns: 1fr;
            }

            .preview-actions {
                flex-direction: column;
            }

            .layout-section {
                padding: 1rem;
            }
        }

        /* Additional Visual Layout Editor Styles */
        .layout-selector {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 12px;
            border: 1px solid #e0e4ff;
        }

        .layout-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
            max-width: 100%;
            overflow: hidden;
        }

        .layout-type {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .layout-type:hover {
            border-color: #ff6b6b;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.1);
        }

        .layout-type.active {
            border-color: #ff6b6b;
            background: #fff8f8;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.15);
        }

        .layout-preview {
            margin-bottom: 1rem;
        }

        .layout-mockup {
            width: 100%;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .featured-mockup .mockup-header { height: 20%; background: #333; }
        .featured-mockup .mockup-featured { height: 60%; background: linear-gradient(45deg, #ff6b6b, #e74c3c); }
        .featured-mockup .mockup-content { height: 20%; background: #f8f9fa; }

        .split-mockup .mockup-header { height: 25%; background: #333; }
        .split-mockup .mockup-left, .split-mockup .mockup-right { height: 75%; width: 50%; float: left; }
        .split-mockup .mockup-left { background: #ff6b6b; }
        .split-mockup .mockup-right { background: #6c757d; }

        .masonry-mockup .mockup-header { height: 25%; background: #333; }
        .masonry-mockup .mockup-grid { height: 75%; display: flex; gap: 2px; padding: 2px; }
        .masonry-mockup .grid-item { flex: 1; background: #ff6b6b; border-radius: 2px; }
        .masonry-mockup .grid-item.tall { flex: 2; background: #28a745; }

        .magazine-mockup .mockup-header { height: 25%; background: #333; }
        .magazine-mockup .mockup-magazine { height: 75%; display: flex; gap: 2px; padding: 2px; }
        .magazine-mockup .mag-main { flex: 2; background: #ff6b6b; }
        .magazine-mockup .mag-sidebar { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .magazine-mockup .mag-item { flex: 1; background: #6c757d; }

        .visual-editor {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 100%;
        }

        /* Ensure visual editor elements only appear in website-layout section */
        .visual-editor,
        .section-editor,
        .visual-layout-container,
        .layout-canvas,
        .editable-text,
        .image-slot,
        .instagram-post,
        .collection-items,
        .about-content {
            display: none !important;
        }

        /* Override: Show visual editor elements ONLY in website-layout section */
        #website-layout .visual-editor,
        #website-layout .section-editor,
        #website-layout .visual-layout-container,
        #website-layout .layout-canvas,
        #website-layout .editable-text,
        #website-layout .image-slot,
        #website-layout .instagram-post,
        #website-layout .collection-items,
        #website-layout .about-content {
            display: block !important;
        }

        /* Special display rules for grid and flex elements */
        #website-layout .layout-images,
        #website-layout .instagram-grid {
            display: grid !important;
        }

        #website-layout .about-content {
            display: flex !important;
        }

        #website-layout .collection-items {
            display: grid !important;
        }

        #website-layout .about-features {
            display: grid !important;
        }

        #website-layout .footer-content {
            display: grid !important;
        }

        /* Ensure all FontAwesome icons are visible in footer */
        #website-layout .footer-section i[class*="fa"] {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            -webkit-font-smoothing: antialiased !important;
        }

        /* Specific styling for contact and social icons */
        #website-layout .contact-item i,
        #website-layout .social-item i {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: #007bff !important;
            margin-right: 0.4rem !important;
        }

        .section-editor {
            border-bottom: 1px solid #e9ecef;
        }

        .section-editor:last-child {
            border-bottom: none;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
        }

        .section-title h4 {
            margin: 0;
            color: #495057;
            font-weight: 600;
        }

        .toggle-section {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem;
            transition: transform 0.3s ease;
        }

        .toggle-section:hover {
            color: #ff6b6b;
        }

        .visual-layout-container {
            padding: 1.5rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }

        .layout-canvas {
            background: #fff;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            min-height: 500px;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
        }

        .layout-header {
            padding: 2rem;
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
            color: white;
            width: 100%;
            box-sizing: border-box;
        }

        .layout-section {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editable-text {
            background: rgba(255,255,255,0.1);
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            min-height: 1.5rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .editable-text:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .editable-text:focus {
            background: rgba(255,255,255,0.3);
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }

        .editable-text.subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .layout-images, .instagram-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(353px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            max-width: 100%;
        }

        .image-slot, .instagram-post {
            position: relative;
            width: 353px;
            height: 353px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 100%;
        }

        .image-slot:hover, .instagram-post:hover {
            border-color: #ff6b6b;
            box-shadow: 0 4px 15px rgba(255,107,107,0.15);
        }

        .image-slot img, .instagram-post img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .image-slot:hover img, .instagram-post:hover img {
            transform: scale(1.05);
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-slot:hover .image-overlay, .instagram-post:hover .image-overlay {
            opacity: 1;
        }

        .image-controls {
            display: flex;
            gap: 0.5rem;
        }

        .image-controls button {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #495057;
            font-size: 0.9rem;
        }

        .image-controls button:hover {
            background: white;
            transform: scale(1.1);
            color: #ff6b6b;
        }

        .instagram-profile {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
        }

        .profile-link {
            background: white !important;
            color: #ff6b6b !important;
            border-color: #ff6b6b !important;
            font-family: monospace;
        }

        .about-content {
            padding: 2rem;
        }

        .about-content .description {
            background: rgba(0,0,0,0.05) !important;
            color: #495057 !important;
            border-color: rgba(0,0,0,0.1) !important;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            white-space: pre-line;
        }

        .about-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .feature-item {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .feature-item h5 {
            color: #ff6b6b;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .feature-item p {
            color: #6c757d;
            font-size: 0.95rem;
            margin: 0;
        }

        .collection-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .collection-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .collection-content {
            padding: 1rem;
        }

        .collection-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .collection-desc {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .collection-btn {
            color: #ff6b6b;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .collection-cta {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 2rem;
        }

        .cta-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .cta-desc {
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .cta-button {
            color: #ff6b6b;
            font-weight: 600;
            border: 1px solid #ff6b6b;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            display: inline-block;
        }

        .about-text-section {
            flex: 1;
            padding-right: 2rem;
        }

        .about-image-section {
            flex: 0 0 300px;
        }

        .about-content {
            display: flex;
            align-items: flex-start;
            gap: 2rem;
        }

        .tagline {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .about-features .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            text-align: left;
            background: transparent;
            padding: 0;
            border: none;
        }

        .feature-content {
            flex: 1;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #333;
        }

        .feature-desc {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .insta-alt-text {
            padding: 0.5rem;
            background: #f8f9fa;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.8rem;
            overflow: hidden;
            word-wrap: break-word;
        }

        .footer-section {
            max-width: 100%;
            overflow: hidden;
            margin-bottom: 0;
        }

        .footer-section .section-title {
            font-weight: 600;
            margin-bottom: 0.6rem;
            color: #333;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .contact-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            max-width: 100%;
            overflow: hidden;
            flex-direction: row;
            gap: 0;
        }

        .contact-item i {
            margin-right: 0.5rem;
            color: #007bff;
            margin-top: 0.1rem;
            min-width: 16px;
            width: 16px;
            font-size: 0.9rem;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            flex-shrink: 0;
            text-align: center;
        }

        /* Ensure contact icons are visible in website-layout section */
        #website-layout .contact-item {
            display: flex !important;
            align-items: flex-start !important;
            flex-direction: row !important;
        }

        #website-layout .contact-item i {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: #007bff !important;
            font-size: 0.9rem !important;
            margin-right: 0.5rem !important;
            margin-top: 0.1rem !important;
            flex-shrink: 0 !important;
            width: 16px !important;
            text-align: center !important;
        }

        .contact-address, .contact-email {
            font-size: 0.8rem;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            flex: 1;
            margin: 0;
        }

        .footer-links {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .footer-link {
            color: #6c757d;
            padding: 0.1rem 0;
            font-size: 0.8rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            margin: 0;
        }

        .social-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.4rem;
            max-width: 100%;
            overflow: hidden;
        }

        .social-item i {
            margin-right: 0.4rem;
            color: #007bff;
            width: 16px;
            min-width: 16px;
            font-size: 0.85rem;
        }

        .social-link {
            font-size: 0.75rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            line-height: 1.2;
        }

        .footer-bottom {
            border-top: 1px solid #e9ecef;
            padding-top: 0.6rem;
            margin-top: 0.8rem;
            text-align: center;
            max-width: 100%;
            overflow: hidden;
        }

        .copyright {
            color: #6c757d;
            font-size: 0.75rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin: 0;
        }

        .image-slot.drag-over, .instagram-post.drag-over {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .image-slot.uploading, .instagram-post.uploading {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .image-slot.uploading::after, .instagram-post.uploading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid #ffc107;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Deployment System Styles */
        .deployment-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .deployment-status.draft {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .deployment-status.deploying {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            animation: pulse 2s infinite;
        }

        .deployment-status.deployed {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }

        .deployment-status.error {
            background: linear-gradient(135deg, #e84393 0%, #fd79a8 100%);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .status-content i {
            font-size: 1.2rem;
        }

        .status-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Deployment History Modal */
        .deployment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .deployment-modal.show {
            display: flex;
        }

        .deployment-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .deployment-modal-header {
            background: #2d3436;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deployment-modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .deployment-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .deployment-modal-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .deployment-modal-body {
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .deployment-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .deployment-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .deployment-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #ff6b6b;
        }

        .deployment-item.current {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-color: #28a745;
        }

        .deployment-item.current::before {
            content: 'LIVE';
            position: absolute;
            top: -1px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0 0 6px 6px;
        }

        .deployment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .deployment-info h4 {
            margin: 0;
            color: #2d3436;
            font-size: 1.1rem;
        }

        .deployment-info .deployment-meta {
            color: #636e72;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .deployment-actions {
            display: flex;
            gap: 0.5rem;
        }

        .deployment-actions .action-btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .deployment-changes {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .deployment-changes h5 {
            margin: 0 0 0.75rem 0;
            color: #495057;
            font-size: 0.95rem;
        }

        .changes-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .changes-list li {
            padding: 0.25rem 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .changes-list li::before {
            content: '';
            color: #ff6b6b;
            margin-right: 0.5rem;
            font-weight: bold;
        }

        .deployment-status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-deployed { background: #d4edda; color: #155724; }
        .status-draft { background: #fff3cd; color: #856404; }
        .status-deploying { background: #cce5ff; color: #004085; }
        .status-failed { background: #f8d7da; color: #721c24; }

        @media (max-width: 1200px) {
            .layout-types-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 1.2rem;
            }
            
            .layout-images, .instagram-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1rem;
                padding: 1.2rem;
            }

            .image-slot, .instagram-post {
                width: 300px;
                height: 300px;
            }
        }

        @media (max-width: 768px) {
            .layout-types-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1rem;
            }
            
            .layout-images, .instagram-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 0.8rem;
                padding: 1rem;
            }

            .image-slot, .instagram-post {
                width: 250px;
                height: 250px;
            }

            .layout-canvas {
                min-height: 400px;
            }

            .visual-layout-container {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .layout-types-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .layout-images, .instagram-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 0.6rem;
                padding: 0.6rem;
            }

            .image-slot, .instagram-post {
                width: 200px;
                height: 200px;
            }

            .layout-type {
                min-height: 150px;
                padding: 1rem;
            }

            .layout-mockup {
                height: 80px;
            }
        }

        /* Footer Section Responsive Design */
        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 0.8rem;
                padding: 0.6rem;
                margin-bottom: 0.8rem;
            }

            .footer-section .section-title {
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
            }

            .contact-item {
                margin-bottom: 0.4rem;
                display: flex !important;
                align-items: flex-start !important;
                flex-direction: row !important;
            }

            .contact-item i {
                margin-right: 0.4rem !important;
                margin-top: 0.1rem !important;
                width: 14px !important;
                font-size: 0.8rem !important;
                flex-shrink: 0 !important;
                display: inline-block !important;
            }

            .contact-address, .contact-email {
                font-size: 0.75rem;
            }

            .footer-link {
                font-size: 0.75rem;
                padding: 0.05rem 0;
            }

            .social-item {
                margin-bottom: 0.3rem;
            }

            .social-link {
                font-size: 0.7rem;
            }

            .footer-bottom {
                padding-top: 0.5rem;
                margin-top: 0.6rem;
            }

            .copyright {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .footer-content {
                grid-template-columns: 1fr;
                gap: 0.8rem;
                padding: 0.5rem;
                margin-bottom: 0.6rem;
            }

            .footer-section {
                text-align: center;
                margin-bottom: 0.8rem;
            }

            .footer-section:last-child {
                margin-bottom: 0;
            }

            .contact-item, .social-item {
                justify-content: flex-start;
                margin-bottom: 0.3rem;
                display: flex !important;
                align-items: flex-start !important;
                flex-direction: row !important;
            }

            .contact-item i,
            .social-item i {
                margin-right: 0.4rem !important;
                margin-top: 0.1rem !important;
                width: 14px !important;
                font-size: 0.75rem !important;
                flex-shrink: 0 !important;
                display: inline-block !important;
            }

            .footer-section .section-title {
                font-size: 0.8rem;
                text-align: center;
                margin-bottom: 0.4rem;
            }

            .contact-address, .contact-email {
                font-size: 0.7rem;
                text-align: left;
            }

            .footer-link {
                font-size: 0.7rem;
                text-align: center;
                padding: 0.02rem 0;
            }

            .social-link {
                font-size: 0.65rem;
                text-align: left;
            }

            .footer-bottom {
                padding-top: 0.4rem;
                margin-top: 0.5rem;
            }

            .copyright {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <h1>BUMABLE Admin</h1>
        <nav class="admin-nav">
            <a href="javascript:void(0)" class="active" onclick="showSection('dashboard')">Dashboard</a>
            <a href="javascript:void(0)" onclick="showSection('orders')">Orders</a>
            <a href="javascript:void(0)" onclick="showSection('products')">Products</a>
            <a href="javascript:void(0)" onclick="showSection('customers')">Customers</a>
            <a href="javascript:void(0)" onclick="showSection('website-layout')">Website Layout</a>
            <a href="../">Back to Store</a>
            <a href="#" onclick="logout()" style="background: #dc3545;">
                Logout
            </a>
        </nav>
    </header>

    <div class="admin-container">
        <!-- Dashboard Stats -->
        <div id="dashboard" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Dashboard Overview</h2>
                <span id="last-updated">Last updated: Loading...</span>
            </div>
            <div class="section-content">
                <div class="stats-grid">
                    <div class="stat-card orders">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
                        <div class="stat-value" id="total-revenue">0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card customers">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="total-customers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card products">
                        <div class="stat-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-value" id="total-products">12</div>
                        <div class="stat-label">Products in Stock</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Management -->
        <div id="orders" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Order Management</h2>
                <div>
                    <button class="action-btn btn-primary" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="action-btn btn-warning" onclick="exportOrdersData()" title="Export Orders to CSV">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label>Status Filter</label>
                        <select id="admin-status-filter" onchange="filterAdminOrders()">
                            <option value="all">All Orders</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="admin-date-from" onchange="filterAdminOrders()">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="admin-date-to" onchange="filterAdminOrders()">
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="table-container" style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-tbody">
                            <tr>
                                <td colspan="8" class="no-orders">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Management -->
        <div id="products" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-box"></i> Product Management</h2>
                <div>
                    <button class="action-btn btn-success" onclick="showAddProductForm()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                    <button class="action-btn btn-primary" onclick="forceSyncProducts()">
                        <i class="fas fa-sync-alt"></i> Sync
                    </button>
                    <button class="action-btn btn-warning" onclick="adminExportProducts()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- Product Stats -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="color: #28a745;">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="products-in-stock">0</div>
                        <div class="stat-label">In Stock</div>
                    </div>
                    <div class="stat-card" style="color: #ffc107;">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="products-low-stock">0</div>
                        <div class="stat-label">Low Stock</div>
                    </div>
                    <div class="stat-card" style="color: #dc3545;">
                        <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="stat-value" id="products-out-stock">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                    <div class="stat-card" style="color: #17a2b8;">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="products-on-sale">0</div>
                        <div class="stat-label">On Sale</div>
                    </div>
                </div>

                <!-- Products Table -->
                <div style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product Name</th>
                                <th>Category</th>
                                <th>Regular Price</th>
                                <th>Sale Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-products-tbody">
                            <tr>
                                <td colspan="8" class="no-orders">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Management -->
        <div id="customers" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Customer Management</h2>
                <div>
                    <button class="action-btn btn-primary" onclick="refreshCustomersData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="action-btn btn-warning" onclick="exportCustomersData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- Customer Tabs -->
                <div class="customer-tabs">
                    <button class="tab-btn active" onclick="showCustomerTab('customers-list')">
                        <i class="fas fa-users"></i> Customers
                    </button>
                    <button class="tab-btn" onclick="showCustomerTab('contact-queries')">
                        <i class="fas fa-comment-dots"></i> Contact Queries
                        <span id="new-queries-badge" class="notification-badge" style="display: none;">0</span>
                    </button>
                </div>

                <!-- Customer Statistics -->
                <div id="customer-statistics" class="stats-grid" style="margin-bottom: 2rem; display: flex;">
                    <div class="stat-card" style="color: #007bff;">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="customers-total">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card" style="color: #28a745;">
                        <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
                        <div class="stat-value" id="customers-new">0</div>
                        <div class="stat-label">New This Month</div>
                    </div>
                    <div class="stat-card" style="color: #ffc107;">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-value" id="customers-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card" style="color: #17a2b8;">
                        <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
                        <div class="stat-value" id="customers-value">0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                </div>

                <!-- Customers List Tab -->
                <div id="customers-list" class="tab-content active">
                    <h3 style="margin-bottom: 1rem;">Customer List</h3>
                    <div style="overflow-x: auto;">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Device Info</th>
                                    <th>Orders</th>
                                    <th>Total Spent</th>
                                    <th>Last Order</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-customers-tbody">
                                <tr>
                                    <td colspan="8" class="no-orders">Loading customers...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contact Queries Tab -->
                <div id="contact-queries" class="tab-content" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Contact Queries</h3>
                    
                    <!-- Contact Queries Statistics -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card" style="color: #007bff;">
                            <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                            <div class="stat-value" id="queries-total">0</div>
                            <div class="stat-label">Total Queries</div>
                        </div>
                        <div class="stat-card" style="color: #ffc107;">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value" id="queries-pending">0</div>
                            <div class="stat-label">Pending Replies</div>
                        </div>
                        <div class="stat-card" style="color: #28a745;">
                            <div class="stat-icon"><i class="fas fa-reply"></i></div>
                            <div class="stat-value" id="queries-replied">0</div>
                            <div class="stat-label">Replied Queries</div>
                        </div>
                        <div class="stat-card" style="color: #17a2b8;">
                            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                            <div class="stat-value" id="queries-today">0</div>
                            <div class="stat-label">Queries Today</div>
                        </div>
                    </div>
                    
                    <div id="queries-list">
                        <!-- Contact queries will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Website Layout Management -->
        <div id="website-layout" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-palette"></i> Website Layout Editor</h2>
                <div>
                    <button class="action-btn btn-success" onclick="deployChanges()">
                        <i class="fas fa-rocket"></i> Deploy to Live
                    </button>
                    <button class="action-btn btn-primary" onclick="saveAsDraft()">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button class="action-btn btn-info" onclick="previewLayout()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button class="action-btn btn-secondary" onclick="showDeploymentHistory()">
                        <i class="fas fa-history"></i> Deploy History
                    </button>
                    <button class="action-btn btn-warning" onclick="resetLayoutToDefault()">
                        <i class="fas fa-bookmark"></i> Save Current Work
                    </button>
                </div>
            </div>
            
            <!-- Deployment Status Bar -->
            <div id="deployment-status" class="deployment-status" style="display: none;">
                <div class="status-content">
                    <i class="fas fa-info-circle"></i>
                    <span id="deployment-message">Ready to deploy</span>
                    <div class="status-actions">
                        <span id="last-deployment">Never deployed</span>
                    </div>
                </div>
            </div>
            
            <!-- Visual Layout Editor -->
            <div class="visual-editor">
                <!-- Hero Section Editor -->
                <div class="section-editor hero-editor">
                    <div class="section-title">
                        <h4><i class="fas fa-star"></i> Hero Section</h4>
                        <button class="toggle-section" onclick="toggleSection('hero')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <div class="visual-layout-container">
                        <div class="layout-canvas">
                            <!-- Hero Layout Visual Representation -->
                            <div class="layout-section hero-layout" id="hero-canvas">
                                <div class="layout-header">
                                    <div class="editable-text" contenteditable="true" data-field="hero-title" placeholder="Click to edit title">
                                        Mom approved<br>Girlfriend removed.
                                    </div>
                                    <div class="editable-text subtitle" contenteditable="true" data-field="hero-subtitle" placeholder="Click to edit subtitle">
                                        Underwear Revolution is where comfort meets cheeky confidence, offering unique underwear for both men and women who dare to stand out. It's not just underwear; it's an attitude you wear.
                                    </div>
                                    <div class="editable-text cta-text" contenteditable="true" data-field="hero-cta" placeholder="Click to edit call-to-action">
                                        Shop Now
                                    </div>
                                    <div class="editable-text sale-text" contenteditable="true" data-field="hero-sale" placeholder="Click to edit sale badge">
                                        Final Sale - Get 30% Off
                                    </div>
                                </div>
                                
                                <div class="layout-images">
                                    <div class="image-slot hero-image-1" onclick="selectImageSlot('hero-1')" ondrop="dropImage(event, 'hero-1')" ondragover="allowDrop(event)">
                                        <img id="hero-img-1" src="../images/hero-product-1.jpg" alt="Hero Image 1">
                                        <div class="image-overlay">
                                            <div class="image-controls">
                                                <button onclick="uploadImage('hero-1')" title="Upload Image">
                                                    <i class="fas fa-upload"></i>
                                                </button>
                                                <button onclick="pasteImage('hero-1')" title="Paste Image">
                                                    <i class="fas fa-paste"></i>
                                                </button>
                                                <button onclick="removeImage('hero-1')" title="Remove Image">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Collection Section Editor -->
                <div class="section-editor discover-editor">
                    <div class="section-title">
                        <h4><i class="fas fa-compass"></i> Product Collection Section</h4>
                        <button class="toggle-section" onclick="toggleSection('discover')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <div class="visual-layout-container">
                        <div class="layout-canvas">
                            <!-- Collection Layout Visual Representation -->
                            <div class="layout-section discover-layout" id="discover-canvas">
                                <div class="layout-header">
                                    <div class="editable-text" contenteditable="true" data-field="discover-title" placeholder="Click to edit title">
                                        Discover BUMABLE
                                    </div>
                                </div>
                                
                                <div class="collection-items">
                                    <div class="collection-item">
                                        <div class="image-slot collection-image-1" onclick="selectImageSlot('collection-1')" ondrop="dropImage(event, 'collection-1')" ondragover="allowDrop(event)">
                                            <img id="collection-img-1" src="../images/hero-product-1.jpg" alt="Collection Image 1">
                                            <div class="image-overlay">
                                                <div class="image-controls">
                                                    <button onclick="uploadImage('collection-1')" title="Upload Image">
                                                        <i class="fas fa-upload"></i>
                                                    </button>
                                                    <button onclick="pasteImage('collection-1')" title="Paste Image">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                    <button onclick="removeImage('collection-1')" title="Remove Image">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="collection-content">
                                            <div class="editable-text collection-name" contenteditable="true" data-field="collection-1-name" placeholder="Collection name"> Bumable Brief</div>
                                            <div class="editable-text collection-desc" contenteditable="true" data-field="collection-1-desc" placeholder="Collection description">Cheery Red, Olive, Lt Grey, Navy, Black</div>
                                            <div class="editable-text collection-btn" contenteditable="true" data-field="collection-1-btn" placeholder="Button text">Shop Briefs</div>
                                        </div>
                                    </div>
                                    
                                    <div class="collection-item">
                                        <div class="image-slot collection-image-2" onclick="selectImageSlot('collection-2')" ondrop="dropImage(event, 'collection-2')" ondragover="allowDrop(event)">
                                            <img id="collection-img-2" src="../images/products/tie-dye/tie-dye-1-main.jpg" alt="Collection Image 2">
                                            <div class="image-overlay">
                                                <div class="image-controls">
                                                    <button onclick="uploadImage('collection-2')" title="Upload Image">
                                                        <i class="fas fa-upload"></i>
                                                    </button>
                                                    <button onclick="pasteImage('collection-2')" title="Paste Image">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                    <button onclick="removeImage('collection-2')" title="Remove Image">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="collection-content">
                                            <div class="editable-text collection-name" contenteditable="true" data-field="collection-2-name" placeholder="Collection name"> Tie & Dye Collection</div>
                                            <div class="editable-text collection-desc" contenteditable="true" data-field="collection-2-desc" placeholder="Collection description">Artistic patterns & unique designs</div>
                                            <div class="editable-text collection-btn" contenteditable="true" data-field="collection-2-btn" placeholder="Button text">Shop Tie-Dye</div>
                                        </div>
                                    </div>
                                    
                                    <div class="collection-item">
                                        <div class="image-slot collection-image-3" onclick="selectImageSlot('collection-3')" ondrop="dropImage(event, 'collection-3')" ondragover="allowDrop(event)">
                                            <img id="collection-img-3" src="../images/trunk-treasure.jpg" alt="Collection Image 3">
                                            <div class="image-overlay">
                                                <div class="image-controls">
                                                    <button onclick="uploadImage('collection-3')" title="Upload Image">
                                                        <i class="fas fa-upload"></i>
                                                    </button>
                                                    <button onclick="pasteImage('collection-3')" title="Paste Image">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                    <button onclick="removeImage('collection-3')" title="Remove Image">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="collection-content">
                                            <div class="editable-text collection-name" contenteditable="true" data-field="collection-3-name" placeholder="Collection name"> Solid Trunks</div>
                                            <div class="editable-text collection-desc" contenteditable="true" data-field="collection-3-desc" placeholder="Collection description">Classic Colors & Premium Comfort</div>
                                            <div class="editable-text collection-btn" contenteditable="true" data-field="collection-3-btn" placeholder="Button text">Shop Trunks</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="collection-cta">
                                    <div class="editable-text cta-title" contenteditable="true" data-field="collection-cta-title" placeholder="CTA title">Ready to upgrade your confidence?</div>
                                    <div class="editable-text cta-desc" contenteditable="true" data-field="collection-cta-desc" placeholder="CTA description">Explore our complete collection and find your perfect fit</div>
                                    <div class="editable-text cta-button" contenteditable="true" data-field="collection-cta-btn" placeholder="CTA button text">Shop Full Collection</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instagram Section Editor -->
                <div class="section-editor instagram-editor">
                    <div class="section-title">
                        <h4><i class="fab fa-instagram"></i> Instagram Section</h4>
                        <button class="toggle-section" onclick="toggleSection('instagram')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <div class="visual-layout-container">
                        <div class="layout-canvas">
                            <!-- Instagram Layout Visual Representation -->
                            <div class="layout-section instagram-layout" id="instagram-canvas">
                                <div class="layout-header">
                                    <div class="editable-text" contenteditable="true" data-field="instagram-title" placeholder="Click to edit title">
                                        Connect on Instagram
                                    </div>
                                </div>
                                
                                <div class="instagram-grid">
                                    <div class="instagram-post" onclick="selectImageSlot('insta-1')" ondrop="dropImage(event, 'insta-1')" ondragover="allowDrop(event)">
                                        <img id="insta-img-1" src="../images/hero-product-1.jpg" alt="Instagram Post 1">
                                        <div class="image-overlay">
                                            <div class="image-controls">
                                                <button onclick="uploadImage('insta-1')" title="Upload Image">
                                                    <i class="fas fa-upload"></i>
                                                </button>
                                                <button onclick="pasteImage('insta-1')" title="Paste Image">
                                                    <i class="fas fa-paste"></i>
                                                </button>
                                                <button onclick="editInstagramLink('insta-1')" title="Edit Link">
                                                    <i class="fas fa-link"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="insta-link-1" value="https://instagram.com/p/example1">
                                        <div class="insta-alt-text">
                                            <div class="editable-text" contenteditable="true" data-field="insta-1-alt" placeholder="Alt text">New Collections - BUMABLE</div>
                                        </div>
                                    </div>
                                    
                                    <div class="instagram-post" onclick="selectImageSlot('insta-2')" ondrop="dropImage(event, 'insta-2')" ondragover="allowDrop(event)">
                                        <img id="insta-img-2" src="../images/trunk-treasure.jpg" alt="Instagram Post 2">
                                        <div class="image-overlay">
                                            <div class="image-controls">
                                                <button onclick="uploadImage('insta-2')" title="Upload Image">
                                                    <i class="fas fa-upload"></i>
                                                </button>
                                                <button onclick="pasteImage('insta-2')" title="Paste Image">
                                                    <i class="fas fa-paste"></i>
                                                </button>
                                                <button onclick="editInstagramLink('insta-2')" title="Edit Link">
                                                    <i class="fas fa-link"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="insta-link-2" value="https://instagram.com/p/example2">
                                        <div class="insta-alt-text">
                                            <div class="editable-text" contenteditable="true" data-field="insta-2-alt" placeholder="Alt text">Comfort First - BUMABLE</div>
                                        </div>
                                    </div>
                                    
                                    <div class="instagram-post" onclick="selectImageSlot('insta-3')" ondrop="dropImage(event, 'insta-3')" ondragover="allowDrop(event)">
                                        <img id="insta-img-3" src="../images/hipsters.jpg" alt="Instagram Post 3">
                                        <div class="image-overlay">
                                            <div class="image-controls">
                                                <button onclick="uploadImage('insta-3')" title="Upload Image">
                                                    <i class="fas fa-upload"></i>
                                                </button>
                                                <button onclick="pasteImage('insta-3')" title="Paste Image">
                                                    <i class="fas fa-paste"></i>
                                                </button>
                                                <button onclick="editInstagramLink('insta-3')" title="Edit Link">
                                                    <i class="fas fa-link"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="insta-link-3" value="https://instagram.com/p/example3">
                                        <div class="insta-alt-text">
                                            <div class="editable-text" contenteditable="true" data-field="insta-3-alt" placeholder="Alt text">Style Guide - BUMABLE</div>
                                        </div>
                                    </div>
                                    
                                    <div class="instagram-post" onclick="selectImageSlot('insta-4')" ondrop="dropImage(event, 'insta-4')" ondragover="allowDrop(event)">
                                        <img id="insta-img-4" src="../images/hero-product-2.jpg" alt="Instagram Post 4">
                                        <div class="image-overlay">
                                            <div class="image-controls">
                                                <button onclick="uploadImage('insta-4')" title="Upload Image">
                                                    <i class="fas fa-upload"></i>
                                                </button>
                                                <button onclick="pasteImage('insta-4')" title="Paste Image">
                                                    <i class="fas fa-paste"></i>
                                                </button>
                                                <button onclick="editInstagramLink('insta-4')" title="Edit Link">
                                                    <i class="fas fa-link"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="insta-link-4" value="https://instagram.com/p/example4">
                                        <div class="insta-alt-text">
                                            <div class="editable-text" contenteditable="true" data-field="insta-4-alt" placeholder="Alt text">Behind the Scenes - BUMABLE</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Our Story Section Editor -->
                <div class="section-editor about-editor">
                    <div class="section-title">
                        <h4><i class="fas fa-book-open"></i> Our Story Section</h4>
                        <button class="toggle-section" onclick="toggleSection('about')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <div class="visual-layout-container">
                        <div class="layout-canvas">
                            <!-- About Layout Visual Representation -->
                            <div class="layout-section about-layout" id="about-canvas">
                                <div class="layout-header">
                                    <div class="editable-text" contenteditable="true" data-field="about-title" placeholder="Click to edit title">
                                        Our Story
                                    </div>
                                    <div class="editable-text subtitle" contenteditable="true" data-field="about-subtitle" placeholder="Click to edit subtitle">
                                        Where comfort meets cheeky confidence
                                    </div>
                                </div>
                                
                                <div class="about-content">
                                    <div class="about-text-section">
                                        <div class="editable-text tagline" contenteditable="true" data-field="about-tagline" placeholder="Click to edit tagline">
                                            Mom approved. Girlfriend removed.
                                        </div>
                                        <div class="editable-text description" contenteditable="true" data-field="about-description" placeholder="Click to edit description">
                                            Underwear Revolution is where comfort meets cheeky confidence, offering unique underwear for both men and women who dare to stand out. It's not just underwear; it's an attitude you wear.

At BUMABLE, we believe that what you wear closest to your skin should make you feel confident, comfortable, and ready to take on the world. Our premium collection combines innovative fabric technology with bold, contemporary designs that speak to your personality.
                                        </div>
                                        
                                        <div class="about-features">
                                            <div class="feature-item">
                                                <div class="feature-icon">
                                                    <i class="fas fa-heart"></i>
                                                </div>
                                                <div class="feature-content">
                                                    <div class="editable-text feature-title" contenteditable="true" data-field="feature-1-title" placeholder="Feature title">Comfort First</div>
                                                    <div class="editable-text feature-desc" contenteditable="true" data-field="feature-1-desc" placeholder="Feature description">Premium materials for all-day comfort</div>
                                                </div>
                                            </div>
                                            <div class="feature-item">
                                                <div class="feature-icon">
                                                    <i class="fas fa-star"></i>
                                                </div>
                                                <div class="feature-content">
                                                    <div class="editable-text feature-title" contenteditable="true" data-field="feature-2-title" placeholder="Feature title">Quality Assured</div>
                                                    <div class="editable-text feature-desc" contenteditable="true" data-field="feature-2-desc" placeholder="Feature description">Rigorous testing for durability and fit</div>
                                                </div>
                                            </div>
                                            <div class="feature-item">
                                                <div class="feature-icon">
                                                    <i class="fas fa-leaf"></i>
                                                </div>
                                                <div class="feature-content">
                                                    <div class="editable-text feature-title" contenteditable="true" data-field="feature-3-title" placeholder="Feature title">Eco-Conscious</div>
                                                    <div class="editable-text feature-desc" contenteditable="true" data-field="feature-3-desc" placeholder="Feature description">Sustainable materials and processes</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="about-image-section">
                                        <div class="image-slot about-image-1" onclick="selectImageSlot('about-1')" ondrop="dropImage(event, 'about-1')" ondragover="allowDrop(event)">
                                            <img id="about-img-1" src="../images/hero-product-2.jpg" alt="Our Story Image">
                                            <div class="image-overlay">
                                                <div class="image-controls">
                                                    <button onclick="uploadImage('about-1')" title="Upload Image">
                                                        <i class="fas fa-upload"></i>
                                                    </button>
                                                    <button onclick="pasteImage('about-1')" title="Paste Image">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                    <button onclick="removeImage('about-1')" title="Remove Image">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Section Editor -->
                <div class="section-editor footer-editor">
                    <div class="section-title">
                        <h4><i class="fas fa-address-card"></i> Footer Section</h4>
                        <button class="toggle-section" onclick="toggleSection('footer')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <div class="visual-layout-container">
                        <div class="layout-canvas">
                            <!-- Footer Layout Visual Representation -->
                            <div class="layout-section footer-layout" id="footer-canvas">
                                <div class="footer-content">
                                    <div class="footer-section contact-section">
                                        <div class="editable-text section-title" contenteditable="true" data-field="footer-contact-title" placeholder="Contact section title">Get in Touch</div>
                                        <div class="contact-info">
                                            <div class="contact-item">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <div class="editable-text contact-address" contenteditable="true" data-field="footer-address" placeholder="Business address">Palavanchipalayam
Tiruppur, Tamilnadu
641605</div>
                                            </div>
                                            <div class="contact-item">
                                                <i class="fas fa-envelope"></i>
                                                <div class="editable-text contact-email" contenteditable="true" data-field="footer-email" placeholder="Email address">ingeniumcouture@gmail.com</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="footer-section links-section">
                                        <div class="editable-text section-title" contenteditable="true" data-field="footer-links-title" placeholder="Links section title">Quick Links</div>
                                        <div class="footer-links">
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-link-1" placeholder="Link 1">Home</div>
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-link-2" placeholder="Link 2">Shop</div>
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-link-3" placeholder="Link 3">Our Story</div>
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-link-4" placeholder="Link 4">Contact Us</div>
                                        </div>
                                    </div>
                                    
                                    <div class="footer-section policies-section">
                                        <div class="editable-text section-title" contenteditable="true" data-field="footer-policies-title" placeholder="Policies section title">Policies</div>
                                        <div class="footer-links">
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-policy-1" placeholder="Policy 1">Store Policy</div>
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-policy-2" placeholder="Policy 2">Shipping & Returns</div>
                                            <div class="editable-text footer-link" contenteditable="true" data-field="footer-policy-3" placeholder="Policy 3">FAQ</div>
                                        </div>
                                    </div>
                                    
                                    <div class="footer-section social-section">
                                        <div class="editable-text section-title" contenteditable="true" data-field="footer-social-title" placeholder="Social section title">Follow Us</div>
                                        <div class="social-links">
                                            <div class="social-item">
                                                <i class="fab fa-facebook-f"></i>
                                                <div class="editable-text social-link" contenteditable="true" data-field="footer-facebook" placeholder="Facebook URL">https://www.facebook.com/profile.php?id=61560298989888</div>
                                            </div>
                                            <div class="social-item">
                                                <i class="fab fa-instagram"></i>
                                                <div class="editable-text social-link" contenteditable="true" data-field="footer-instagram" placeholder="Instagram URL">https://www.instagram.com/bumableclothing/</div>
                                            </div>
                                            <div class="social-item">
                                                <i class="fab fa-pinterest"></i>
                                                <div class="editable-text social-link" contenteditable="true" data-field="footer-pinterest" placeholder="Pinterest URL">https://in.pinterest.com/bumableclothing/</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="footer-bottom">
                                    <div class="editable-text copyright" contenteditable="true" data-field="footer-copyright" placeholder="Copyright text">&copy; 2025 by BUMABLE. All rights reserved.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Panel -->
            <!-- Quick Actions removed per user request -->
        </div>

        <!-- Contact Query Reply Modal -->
        <div id="reply-modal" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <h3><i class="fas fa-reply"></i> Reply to Query</h3>
                    <button class="close-btn" onclick="closeReplyModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="popup-body">
                    <div class="query-details">
                        <p><strong>Customer:</strong> <span id="reply-customer-name"></span></p>
                        <p><strong>Email:</strong> <span id="reply-customer-email"></span></p>
                        <p><strong>Original Message:</strong></p>
                        <div id="reply-original-message" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 0.5rem 0;"></div>
                    </div>
                    <div class="reply-form">
                        <label for="admin-reply">Your Reply:</label>
                        <textarea id="admin-reply" rows="5" placeholder="Type your reply here..." style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="popup-footer">
                    <button class="btn-secondary" onclick="closeReplyModal()">Cancel</button>
                    <button class="btn-primary" onclick="sendReply()">Send Reply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Supabase SDK and database scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/logger.js"></script>
    <script src="../js/supabase-db.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/products.js"></script>
    <script src="vercel-deploy.js"></script>
    
    <script>
        // Global variables for visual editor
        let currentLayoutType = 'featured';
        let clipboardImageData = null;
        
        let allAdminOrders = [];

        // Auto-configure Supabase
        function initSupabaseConfig() {
            if (!localStorage.getItem('supabase_url')) {
                localStorage.setItem('supabase_url', 'https://dovwxwqjsqgpsskwnqwc.supabase.co');
                localStorage.setItem('supabase_key', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvdnd4d3Fqc3FncHNza3ducXdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDQ0NzUsImV4cCI6MjA4MTM4MDQ3NX0.-mtkMmsMyKo01Zn0hxlNzuj-_p3JmWVbXz8_fJXtVaY');
                console.log(' Admin: Supabase configuration initialized');
            }
            
            // Initialize Supabase client
            const supabaseUrl = localStorage.getItem('supabase_url');
            const supabaseKey = localStorage.getItem('supabase_key');
            
            if (supabaseUrl && supabaseKey && window.supabase) {
                window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                window.supabase = window.supabaseClient;
                console.log(' Supabase initialized successfully');
                
                // Initialize Supabase database
                if (!window.supabaseDB) {
                    window.supabaseDB = new SupabaseDB();
                    console.log(' Admin: Supabase database initialized');
                }
                
                return true;
            } else {
                console.warn(' Supabase configuration missing or library not loaded');
                return false;
            }
        }

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Supabase first
            const supabaseReady = initSupabaseConfig();
            
            // Wait a moment for Supabase to initialize
            setTimeout(async () => {
                // Check authentication first
                if (!checkAdminAuthentication()) {
                    return; // Redirected to login
                }
                
                await loadAdminData();
                updateLastUpdated();
                
                // Initialize deployment system if Supabase is ready
                if (supabaseReady) {
                    console.log('Initializing deployment system...');
                    try {
                        await initializeDeploymentSystem();
                        console.log(' Deployment system initialized');
                    } catch (error) {
                        console.error(' Deployment system initialization failed:', error);
                    }
                }
                
                // Initialize product sync
                initializeProductSync();
                
                // Show dashboard by default
                showSection('dashboard');
            }, 1000);
        });

        // Check admin authentication
        function checkAdminAuthentication() {
            const adminSession = localStorage.getItem('bumableAdminSession');
            
            if (!adminSession) {
                redirectToLogin('No session found. Please login.');
                return false;
            }
            
            try {
                const session = JSON.parse(adminSession);
                const now = new Date().getTime();
                
                if (session.expires <= now) {
                    localStorage.removeItem('bumableAdminSession');
                    redirectToLogin('Session expired. Please login again.');
                    return false;
                }
                
                // Update header with admin info
                updateAdminHeader(session);
                return true;
                
            } catch (e) {
                localStorage.removeItem('bumableAdminSession');
                redirectToLogin('Invalid session. Please login again.');
                return false;
            }
        }

        // Redirect to login page
        function redirectToLogin(message) {
            // Silent redirect without alert message
            window.location.href = '../login/';
        }

        // Update admin header with session info
        function updateAdminHeader(session) {
            const headerTitle = document.querySelector('.admin-header h1');
            if (headerTitle) {
                headerTitle.innerHTML = `${session.username}`;
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('bumableAdminSession');
                alert('Logged out successfully!');
                window.location.href = 'admin-login.html';
            }
        }

        // Load all admin data from Supabase cloud database
        async function loadAdminData() {
            await loadDashboardStats();
            await loadAdminOrders();
            await loadCustomersData();
            loadAdminProducts(); // Keep this synchronous for now
            loadContactQueries(); // Keep this synchronous for now
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                    console.log('Supabase not ready, using default stats');
                    document.getElementById('total-orders').textContent = '0';
                    document.getElementById('total-revenue').textContent = '0';
                    document.getElementById('total-customers').textContent = '0';
                    return;
                }

                // Get data from Supabase cloud database
                const ordersResult = await window.supabaseDB.getAllOrders();
                const customersResult = await window.supabaseDB.getAllUsers();
                
                const orders = ordersResult.success ? ordersResult.orders : [];
                const customers = customersResult.success ? customersResult.users : [];
                
                // Calculate stats
                const totalOrders = orders.length;
                const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalCustomers = customers.length;
                
                // Update dashboard
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString('en-IN')}`;
                document.getElementById('total-customers').textContent = totalCustomers;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Fallback to default values
                document.getElementById('total-orders').textContent = '0';
                document.getElementById('total-revenue').textContent = '0';
                document.getElementById('total-customers').textContent = '0';
            }
        }

        // Load orders from Supabase cloud database
        async function loadAdminOrders() {
            try {
                if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                    console.log('Supabase not ready, showing empty orders');
                    allAdminOrders = [];
                    displayAdminOrders([]);
                    return;
                }

                const result = await window.supabaseDB.getAllOrders();
                if (result.success) {
                    allAdminOrders = result.orders;
                    displayAdminOrders(allAdminOrders);
                    console.log(` Loaded ${allAdminOrders.length} orders from cloud database`);
                } else {
                    console.error('Failed to load orders from Supabase:', result.error);
                    allAdminOrders = [];
                    displayAdminOrders([]);
                }
            } catch (error) {
                console.error('Error loading admin orders:', error);
                allAdminOrders = [];
                displayAdminOrders([]);
            }
        }

        // Display orders in admin table
        function displayAdminOrders(orders) {
            const tbody = document.getElementById('admin-orders-tbody');
            
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-orders">No orders found</td></tr>';
                return;
            }

            // Sort by date (newest first)
            orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            tbody.innerHTML = orders.map(order => createAdminOrderRow(order)).join('');
        }

        // Create admin order table row
        function createAdminOrderRow(order) {
            const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN');
            const statusClass = `status-${(order.status || 'confirmed').toLowerCase()}`;
            const statusText = order.status || 'Confirmed';
            
            const itemsCount = order.items ? order.items.length : 0;
            const itemsText = itemsCount === 1 ? '1 item' : `${itemsCount} items`;
            
            const customerName = order.firstName && order.lastName 
                ? `${order.firstName} ${order.lastName}` 
                : 'N/A';
            
            return `
                <tr>
                    <td><strong>${order.orderId}</strong></td>
                    <td>
                        <div>${customerName}</div>
                        <div class="customer-info">${order.email || ''}</div>
                        <div class="customer-info">${order.phone || ''}</div>
                    </td>
                    <td>${orderDate}</td>
                    <td>${itemsText}</td>
                    <td class="order-total">${order.total.toLocaleString('en-IN')}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${order.payment || 'COD'}</td>
                    <td>
                        <button class="action-btn btn-primary" onclick="viewOrderSummary('${order.orderId}')" title="Order Summary">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="action-btn btn-warning" onclick="openStatusPopup('${order.orderId}', '${order.status || 'pending'}')" title="Update Status">
                            <i class="fas fa-edit"></i>
                            Status
                        </button>
                        <button class="action-btn btn-danger" onclick="deleteOrder('${order.orderId}')" title="Delete Order">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Filter admin orders
        function filterAdminOrders() {
            const statusFilter = document.getElementById('admin-status-filter').value;
            const dateFrom = document.getElementById('admin-date-from').value;
            const dateTo = document.getElementById('admin-date-to').value;

            let filteredOrders = [...allAdminOrders];

            // Filter by status
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => 
                    (order.status || 'confirmed').toLowerCase() === statusFilter
                );
            }

            // Filter by date range
            if (dateFrom) {
                filteredOrders = filteredOrders.filter(order => 
                    new Date(order.orderDate) >= new Date(dateFrom)
                );
            }

            if (dateTo) {
                filteredOrders = filteredOrders.filter(order => 
                    new Date(order.orderDate) <= new Date(dateTo)
                );
            }

            displayAdminOrders(filteredOrders);
        }

        // View order summary with PDF download option
        function viewOrderSummary(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) {
                alert('Order not found!');
                return;
            }

            const customerName = `${order.firstName || ''} ${order.lastName || ''}`.trim() || 'N/A';
            const customerEmail = order.email || 'N/A';
            const customerPhone = order.phone || 'N/A';
            
            const address = order.address1 
                ? `${order.address1}${order.address2 ? ', ' + order.address2 : ''}, ${order.city || ''}, ${order.state || ''} ${order.zipCode || ''}`
                : 'N/A';

            const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const itemsTableRows = order.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.size || 'M'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price.toLocaleString('en-IN')}</td>
                    <td>${(item.price * item.quantity).toLocaleString('en-IN')}</td>
                </tr>
            `).join('');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'order-summary-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; width: 95%;">
                    <div class="modal-header">
                        <h3>Order Summary</h3>
                        <button type="button" class="modal-close" onclick="closeOrderSummary()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="order-summary" id="order-summary-content">
                            <div class="order-summary-header">
                                <h2>BUMABLE</h2>
                                <div class="company-info">Premium Clothing Store</div>
                                <div class="company-info">Order Summary</div>
                            </div>

                            <div class="summary-section">
                                <h3>Order Information</h3>
                                <div class="summary-row">
                                    <span><strong>Order ID:</strong></span>
                                    <span>${order.orderId}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Order Date:</strong></span>
                                    <span>${orderDate}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Status:</strong></span>
                                    <span><span class="status-badge status-${(order.status || 'confirmed').toLowerCase()}">${order.status || 'Confirmed'}</span></span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Payment Method:</strong></span>
                                    <span>${order.payment || 'Cash on Delivery'}</span>
                                </div>
                            </div>

                            <div class="summary-section">
                                <h3>Customer Details</h3>
                                <div class="summary-row">
                                    <span><strong>Name:</strong></span>
                                    <span>${customerName}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Email:</strong></span>
                                    <span>${customerEmail}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Phone:</strong></span>
                                    <span>${customerPhone}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Delivery Address:</strong></span>
                                    <span>${address}</span>
                                </div>
                            </div>

                            <div class="summary-section">
                                <h3>Order Items</h3>
                                <table class="order-items-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Size</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsTableRows}
                                    </tbody>
                                </table>
                            </div>

                            <div class="summary-section">
                                <h3>Order Total</h3>
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>${order.subtotal.toLocaleString('en-IN')}</span>
                                </div>
                                <div class="summary-row">
                                    <span>GST (18%):</span>
                                    <span>${order.tax.toLocaleString('en-IN')}</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Grand Total:</span>
                                    <span>${order.total.toLocaleString('en-IN')}</span>
                                </div>
                            </div>

                            <button class="download-pdf-btn" onclick="downloadOrderPDF('${orderId}')">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Close order summary modal
        function closeOrderSummary() {
            const modal = document.getElementById('order-summary-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Download order summary as PDF
        function downloadOrderPDF(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) {
                alert('Order not found!');
                return;
            }

            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank', 'width=800,height=1000');
            const customerName = `${order.firstName || ''} ${order.lastName || ''}`.trim() || 'N/A';
            const address = order.address1 
                ? `${order.address1}${order.address2 ? ', ' + order.address2 : ''}, ${order.city || ''}, ${order.state || ''} ${order.zipCode || ''}`
                : 'N/A';

            const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const itemsTableRows = order.items.map(item => `
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.size || 'M'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${item.price.toLocaleString('en-IN')}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${(item.price * item.quantity).toLocaleString('en-IN')}</td>
                </tr>
            `).join('');

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Order Summary - ${orderId}</title>
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 20px; color: #333; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #097969; padding-bottom: 15px; margin-bottom: 20px; }
                        .header h1 { color: #097969; margin: 0; font-size: 28px; }
                        .header .company-info { margin-top: 5px; color: #666; font-size: 14px; }
                        .section { margin-bottom: 20px; }
                        .section h2 { color: #097969; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; font-size: 18px; }
                        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 5px 0; }
                        .total-row { border-top: 1px solid #ddd; font-weight: bold; font-size: 18px; margin-top: 10px; padding-top: 10px; }
                        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        .items-table th { background-color: #f8f9fa; font-weight: bold; color: #097969; padding: 10px 8px; border-bottom: 2px solid #097969; }
                        .items-table td { padding: 8px; border-bottom: 1px solid #ddd; }
                        .status-badge { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; text-transform: uppercase; }
                        .status-confirmed { background: #d4edda; color: #155724; }
                        .status-processing { background: #fff3cd; color: #856404; }
                        .status-shipped { background: #cce5ff; color: #004085; }
                        .status-delivered { background: #d1ecf1; color: #0c5460; }
                        .status-cancelled { background: #f8d7da; color: #721c24; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>BUMABLE</h1>
                        <div class="company-info">Premium Clothing Store</div>
                        <div class="company-info">Order Summary</div>
                    </div>

                    <div class="section">
                        <h2>Order Information</h2>
                        <div class="info-row">
                            <span><strong>Order ID:</strong></span>
                            <span>${order.orderId}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Order Date:</strong></span>
                            <span>${orderDate}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Status:</strong></span>
                            <span><span class="status-badge status-${(order.status || 'confirmed').toLowerCase()}">${order.status || 'Confirmed'}</span></span>
                        </div>
                        <div class="info-row">
                            <span><strong>Payment Method:</strong></span>
                            <span>${order.payment || 'Cash on Delivery'}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Customer Details</h2>
                        <div class="info-row">
                            <span><strong>Name:</strong></span>
                            <span>${customerName}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Email:</strong></span>
                            <span>${order.email || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Phone:</strong></span>
                            <span>${order.phone || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Delivery Address:</strong></span>
                            <span>${address}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Order Items</h2>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Product</th>
                                    <th style="text-align: center;">Size</th>
                                    <th style="text-align: center;">Qty</th>
                                    <th style="text-align: right;">Price</th>
                                    <th style="text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsTableRows}
                            </tbody>
                        </table>
                    </div>

                    <div class="section">
                        <h2>Order Total</h2>
                        <div class="info-row">
                            <span>Subtotal:</span>
                            <span>${order.subtotal.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="info-row">
                            <span>GST (18%):</span>
                            <span>${order.tax.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="info-row total-row">
                            <span><strong>Grand Total:</strong></span>
                            <span><strong>${order.total.toLocaleString('en-IN')}</strong></span>
                        </div>
                    </div>

                    <scr` + `ipt>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    </scr` + `ipt>
                </body>
                </html>
            `;

            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // View order details
        function viewOrderDetails(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) return;

            const itemsList = order.items.map(item => 
                ` ${item.name} (Size: ${item.size || 'M'}, Qty: ${item.quantity}) - ${(item.price * item.quantity).toLocaleString('en-IN')}`
            ).join('\n');

            const address = order.address1 
                ? `${order.address1}${order.address2 ? ', ' + order.address2 : ''}, ${order.city || ''}, ${order.state || ''} ${order.zipCode || ''}`
                : 'N/A';

            alert(`Order Details - ${orderId}

Customer: ${order.firstName || ''} ${order.lastName || ''}
Email: ${order.email || 'N/A'}
Phone: ${order.phone || 'N/A'}
Address: ${address}

Items:
${itemsList}

Subtotal: ${order.subtotal.toLocaleString('en-IN')}
Tax (GST): ${order.tax.toLocaleString('en-IN')}
Total: ${order.total.toLocaleString('en-IN')}

Payment Method: ${order.payment || 'Cash on Delivery'}
Status: ${order.status || 'Confirmed'}
Order Date: ${new Date(order.orderDate).toLocaleString('en-IN')}`);
        }

        // Update order status
        async function updateOrderStatus(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) return;

            const newStatus = prompt(`Update status for order ${orderId}:

Current Status: ${order.status || 'Confirmed'}

Enter new status (confirmed/processing/shipped/delivered/cancelled):`, order.status || 'confirmed');

            if (newStatus && ['confirmed', 'processing', 'shipped', 'delivered', 'cancelled'].includes(newStatus.toLowerCase())) {
                // Update in Supabase
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const result = await window.supabaseDB.updateOrderStatus(order.id, newStatus.toLowerCase());
                    if (result.success) {
                        alert(`Order ${orderId} status updated to: ${newStatus}`);
                        // Refresh display from Supabase
                        await loadAdminData();
                    } else {
                        alert(`Failed to update order status: ${result.error}`);
                    }
                } else {
                    alert('Database not connected. Please check Supabase configuration.');
                }
            }
        }

        // Update order status to specific status (from dropdown)
        async function updateOrderStatusTo(orderId, newStatus) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) return;

            // Confirm the status change
            const statusLabels = {
                'confirmed': 'Confirmed',
                'processing': 'Processing', 
                'shipped': 'Shipped',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };

            if (confirm(`Change order ${orderId} status to "${statusLabels[newStatus]}"?`)) {
                // Update in Supabase
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const result = await window.supabaseDB.updateOrderStatus(order.id, newStatus);
                    if (result.success) {
                        alert(`Order ${orderId} status updated to: ${statusLabels[newStatus]}`);
                        // Refresh display from Supabase
                        await loadAdminData();
                    } else {
                        alert(`Failed to update order status: ${result.error}`);
                    }
                } else {
                    alert('Database not connected. Please check Supabase configuration.');
                }
            }

            // Close any open dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }

        // Cancel order
        async function cancelOrder(orderId) {
            if (confirm(`Are you sure you want to cancel order ${orderId}?`)) {
                const order = allAdminOrders.find(o => o.orderId === orderId);
                if (order) {
                    // Update in Supabase
                    if (window.supabaseDB && window.supabaseDB.isReady()) {
                        const result = await window.supabaseDB.updateOrderStatus(order.id, 'cancelled');
                        if (result.success) {
                            alert(`Order ${orderId} has been cancelled.`);
                            // Refresh display from Supabase
                            await loadAdminData();
                        } else {
                            alert(`Failed to cancel order: ${result.error}`);
                        }
                    } else {
                        alert('Database not connected. Please check Supabase configuration.');
                    }
                }
            }
        }

        // Refresh orders
        function refreshOrders() {
            loadAdminData();
            updateLastUpdated();
            alert('Data refreshed successfully!');
        }

        // Show specific section
        function showSection(sectionName) {
            
            // Update nav active state
            document.querySelectorAll('.admin-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the clicked nav link
            const navLinks = document.querySelectorAll('.admin-nav a');
            navLinks.forEach(link => {
                const onclick = link.getAttribute('onclick');
                if (onclick && onclick.includes(`'${sectionName}'`)) {
                    link.classList.add('active');
                }
            });
            
            // Hide all sections
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the requested section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // Load data for specific sections
                if (sectionName === 'products') {
                    loadAdminProducts();
                } else if (sectionName === 'orders') {
                    loadAdminOrders();
                } else if (sectionName === 'customers') {
                    loadCustomersData();
                } else if (sectionName === 'dashboard') {
                    loadAdminData();
                }
            } else {
                console.error('Section not found:', sectionName);
            }
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            document.getElementById('last-updated').textContent = 
                `Last updated: ${new Date().toLocaleTimeString('en-IN')}`;
        }

        // ===== PRODUCT SYNCHRONIZATION FUNCTIONS =====
        
        // Initialize product synchronization with Supabase
        async function initializeProductSync() {
            try {
                console.log('Initializing Supabase product sync...');
                
                if (!window.supabaseDB) {
                    console.log('Waiting for Supabase connection...');
                    setTimeout(initializeProductSync, 500);
                    return;
                }
                
                // Initial load of products and stats
                await loadAdminProducts();
                console.log('Product synchronization initialized with Supabase cloud database');
                
                // Set up real-time listeners for cross-device sync
                setupRealtimeProductSync();
                
            } catch (error) {
                console.error('Error initializing product sync:', error);
                setTimeout(initializeProductSync, 2000); // Retry after 2 seconds
            }
        }

        // Setup real-time synchronization for cross-device updates
        function setupRealtimeProductSync() {
            // Listen for custom events from product updates
            window.addEventListener('productUpdated', async function(event) {
                console.log('Product updated event received:', event.detail);
                await updateProductStats();
            });
            
            window.addEventListener('productAdded', async function(event) {
                console.log('Product added event received:', event.detail);
                await loadAdminProducts();
            });
            
            window.addEventListener('productDeleted', async function(event) {
                console.log('Product deleted event received:', event.detail);
                await loadAdminProducts();
            });
            
            console.log('Real-time product sync listeners established');
        }

        // Update product statistics from Supabase
        async function updateProductStats() {
            try {
                if (!window.supabaseDB) {
                    console.log('Supabase DB not available for stats update');
                    return;
                }
                
                const products = await window.supabaseDB.getAllProducts();
                const inStockCount = products.filter(p => p.in_stock && p.stock_count > 0).length;
                const lowStockCount = products.filter(p => p.stock_count <= 10 && p.stock_count > 0).length;
                const outOfStockCount = products.filter(p => !p.in_stock || p.stock_count === 0).length;
                const onSaleCount = products.filter(p => p.on_sale).length;
                
                // Update main dashboard product count
                const totalProductsEl = document.getElementById('total-products');
                if (totalProductsEl) totalProductsEl.textContent = products.length;
                
                // Update product management stats
                const inStockEl = document.getElementById('products-in-stock');
                const lowStockEl = document.getElementById('products-low-stock');
                const outStockEl = document.getElementById('products-out-stock');
                const onSaleEl = document.getElementById('products-on-sale');
                
                if (inStockEl) inStockEl.textContent = inStockCount;
                if (lowStockEl) lowStockEl.textContent = lowStockCount;
                if (outStockEl) outStockEl.textContent = outOfStockCount;
                if (onSaleEl) onSaleEl.textContent = onSaleCount;
                
                console.log('Product stats updated from Supabase:', {
                    total: products.length,
                    inStock: inStockCount,
                    lowStock: lowStockCount,
                    outOfStock: outOfStockCount,
                    onSale: onSaleCount
                });
                
            } catch (error) {
                console.error('Error updating product stats:', error);
            }
        }

        // Load admin products from Supabase
        async function loadAdminProducts() {
            console.log('Loading admin products from Supabase...');
            
            try {
                // Ensure database connection
                if (!window.supabaseDB) {
                    console.log('Waiting for Supabase connection...');
                    setTimeout(loadAdminProducts, 500);
                    return;
                }
                
                await updateProductStats();
                await displayAdminProducts();
                console.log('Admin products loaded successfully from cloud database');
                
            } catch (error) {
                console.error('Error loading admin products:', error);
                const tbody = document.getElementById('admin-products-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="no-orders" style="color: #e74c3c;">Error loading products from database</td></tr>';
                }
            }
        }

        // Display products in admin table from Supabase
        async function displayAdminProducts() {
            console.log('Displaying admin products from Supabase...');
            
            try {
                const products = await window.supabaseDB.getAllProducts();
                console.log('Products loaded from Supabase:', products.length, products);
                
                const tbody = document.getElementById('admin-products-tbody');
                
                if (!tbody) {
                    console.error('Product table body not found');
                    return;
                }
                
                if (!products || products.length === 0) {
                    console.log('No products found in database');
                    tbody.innerHTML = '<tr><td colspan="8" class="no-orders">No products found in database</td></tr>';
                    return;
                }

                console.log('Creating product rows from cloud data...');
                tbody.innerHTML = products.map(product => createAdminProductRow(product)).join('');
                console.log('Products displayed successfully from cloud database');
                
            } catch (error) {
                console.error('Error displaying products:', error);
                const tbody = document.getElementById('admin-products-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="no-orders" style="color: #e74c3c;">Error displaying products</td></tr>';
                }
            }
        }

        // Create admin product table row (Supabase data structure)
        function createAdminProductRow(product) {
            const stockStatus = product.stock_count <= 0 ? 'Out of Stock' : 
                               product.stock_count <= 10 ? 'Low Stock' : 'In Stock';
            const stockClass = product.stock_count <= 0 ? 'status-cancelled' : 
                              product.stock_count <= 10 ? 'status-processing' : 'status-confirmed';
            
            return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            ${product.gallery_images && Array.isArray(product.gallery_images) && product.gallery_images.length > 0 ? 
                                '<img src="' + product.gallery_images[0] + '" alt="' + product.name + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.src=\'images/placeholder-product.svg\'">' :
                                '<img src="' + (product.image_url || '../images/products/default.jpg') + '" alt="' + product.name + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.src=\'images/placeholder-product.svg\'">'
                            }
                        </div>
                    </td>
                    <td>
                        <strong>${product.name}</strong>
                        <div class="customer-info">${product.description || ''}</div>
                    </td>
                    <td>${product.category}</td>
                    <td>
                        <input type="number" value="${product.regular_price}" min="0" step="0.01" 
                               onchange="quickUpdatePrice('${product.id}', this.value, true)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                    </td>
                    <td>
                        <input type="number" value="${product.sale_price || ''}" min="0" step="0.01" 
                               placeholder="No sale"
                               onchange="quickUpdateSalePrice('${product.id}', this.value)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                        ${product.on_sale ? '<span class="status-badge status-confirmed" style="margin-left: 5px;">SALE</span>' : ''}
                    </td>
                    <td>
                        <input type="number" value="${product.stock_count}" min="0" 
                               onchange="quickUpdateStock('${product.id}', this.value)"
                               style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                    </td>
                    <td>
                        <span class="status-badge ${stockClass}">${stockStatus}</span>
                    </td>
                    <td>
                        <button class="action-btn btn-primary" onclick="editProductDetails('${product.id}')" title="Edit Details">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-warning" onclick="toggleProductSale('${product.id}')" title="Toggle Sale">
                            <i class="fas fa-tag"></i>
                        </button>
                        <button class="action-btn btn-danger" onclick="deleteProductConfirm('${product.id}')" title="Delete Product">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Quick update functions using Supabase
        async function quickUpdatePrice(productId, newPrice, isRegular = true) {
            try {
                const price = parseFloat(newPrice);
                if (isNaN(price) || price < 0) {
                    alert('Please enter a valid price');
                    await loadAdminProducts(); // Reload to reset
                    return;
                }
                
                const updates = isRegular ? { regular_price: price } : { sale_price: price };
                
                const success = await adminUpdateProduct(productId, updates);
                if (success) {
                    console.log(`Updated ${isRegular ? 'regular' : 'sale'} price for ${productId}: ${price}`);
                    await updateProductStats(); // Update stats after successful change
                } else {
                    alert('Failed to update price');
                    await loadAdminProducts();
                }
            } catch (error) {
                console.error('Error updating price:', error);
                alert('Error updating price. Please try again.');
                await loadAdminProducts();
            }
        }

        async function quickUpdateSalePrice(productId, newPrice) {
            try {
                if (newPrice === '' || newPrice == '0') {
                    // Remove sale
                    await adminUpdateProduct(productId, { sale_price: null, on_sale: false });
                } else {
                    const price = parseFloat(newPrice);
                    if (isNaN(price) || price < 0) {
                        alert('Please enter a valid sale price');
                        await loadAdminProducts();
                        return;
                    }
                    await adminUpdateProduct(productId, { sale_price: price, on_sale: true });
                }
                await loadAdminProducts();
            } catch (error) {
                console.error('Error updating sale price:', error);
                alert('Error updating sale price. Please try again.');
                await loadAdminProducts();
            }
        }

        async function quickUpdateStock(productId, newStock) {
            try {
                const stock = parseInt(newStock);
                if (isNaN(stock) || stock < 0) {
                    alert('Please enter a valid stock quantity');
                    await loadAdminProducts();
                    return;
                }
                
                const success = await adminUpdateProductStock(productId, stock);
                if (success) {
                    console.log(`Updated stock for ${productId}: ${stock}`);
                    await loadAdminProducts();
                } else {
                    alert('Failed to update stock');
                    await loadAdminProducts();
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                alert('Error updating stock. Please try again.');
                await loadAdminProducts();
            }
        }

        async function toggleProductSale(productId) {
            try {
                const products = await window.supabaseDB.getAllProducts();
                const product = products.find(p => p.id === productId);
                if (!product) return;
                
                const newSaleStatus = !product.on_sale;
                
                if (newSaleStatus && !product.sale_price) {
                    const salePrice = prompt(`Enter sale price for ${product.name}:`, Math.floor(product.regular_price * 0.8));
                    if (salePrice && !isNaN(parseFloat(salePrice))) {
                        await adminUpdateProduct(productId, { 
                            sale_price: parseFloat(salePrice), 
                            on_sale: true 
                        });
                        await loadAdminProducts();
                    }
                } else {
                    await adminUpdateProduct(productId, { on_sale: newSaleStatus });
                    await loadAdminProducts();
                }
            } catch (error) {
                console.error('Error toggling sale status:', error);
                alert('Error updating sale status. Please try again.');
            }
        }

        async function deleteProductConfirm(productId) {
            try {
                const products = await window.supabaseDB.getAllProducts();
                const product = products.find(p => p.id === productId);
                if (!product) return;
                
                if (confirm(`Are you sure you want to delete "${product.name}"?\n\nThis action cannot be undone and will affect all devices instantly.`)) {
                    const success = await adminDeleteProduct(productId);
                    if (success) {
                        alert('Product deleted successfully and updated across all devices!');
                        await loadAdminProducts();
                    } else {
                        alert('Failed to delete product');
                    }
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product. Please try again.');
            }
        }

        async function editProductDetails(productId) {
            try {
                const products = await window.supabaseDB.getAllProducts();
                const product = products.find(p => p.id === productId);
                if (!product) {
                    alert('Product not found');
                    return;
                }
                
                // Create comprehensive edit form with Supabase data structure
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; width: 90%;">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Edit Product: ${product.name}</h3>
                            <button type="button" class="modal-close" onclick="closeProductModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-product-form" onsubmit="saveEditedProduct(event, '${productId}')">
                                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit-product-name">Product Name *</label>
                                        <input type="text" id="edit-product-name" name="name" value="${product.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-product-category">Category *</label>
                                        <select id="edit-product-category" name="category" required>
                                            <option value="">Select Category</option>
                                            <option value="briefs" ${product.category === 'briefs' ? 'selected' : ''}>Briefs</option>
                                            <option value="trunks" ${product.category === 'trunks' ? 'selected' : ''}>Trunks</option>
                                            <option value="tie-dye" ${product.category === 'tie-dye' ? 'selected' : ''}>Tie-Dye</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-product-regular-price">Regular Price () *</label>
                                        <input type="number" id="edit-product-regular-price" name="regular_price" min="0" step="0.01" value="${product.regular_price}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-product-sale-price">Sale Price ()</label>
                                        <input type="number" id="edit-product-sale-price" name="sale_price" min="0" step="0.01" value="${product.sale_price || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-product-stock">Stock Count *</label>
                                        <input type="number" id="edit-product-stock" name="stock_count" min="0" value="${product.stock_count}" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Available Sizes</label>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                                            <label><input type="checkbox" name="sizes" value="S" ${product.available_sizes && product.available_sizes.includes('S') ? 'checked' : ''}> S</label>
                                            <label><input type="checkbox" name="sizes" value="M" ${product.available_sizes && product.available_sizes.includes('M') ? 'checked' : ''}> M</label>
                                            <label><input type="checkbox" name="sizes" value="L" ${product.available_sizes && product.available_sizes.includes('L') ? 'checked' : ''}> L</label>
                                            <label><input type="checkbox" name="sizes" value="XL" ${product.available_sizes && product.available_sizes.includes('XL') ? 'checked' : ''}> XL</label>
                                            <label><input type="checkbox" name="sizes" value="XXL" ${product.available_sizes && product.available_sizes.includes('XXL') ? 'checked' : ''}> XXL</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit-product-description">Description</label>
                                    <textarea id="edit-product-description" name="description" rows="3" placeholder="Enter product description...">${product.description || ''}</textarea>
                                </div>
                                
                                <!-- Current Images Display -->
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>Product Images</label>
                                    <div id="current-images-display" style="margin-top: 10px;">
                                        <div id="existing-images" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                                            ${product.gallery_images && product.gallery_images.length > 0 ? 
                                                product.gallery_images.map((img, index) => `
                                                    <div class="image-item" style="position: relative; display: inline-block;">
                                                        <img src="${img}" alt="${product.name} ${index + 1}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.src='../images/placeholder-product.svg'">
                                                        <button type="button" onclick="removeExistingImage(${index})" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px;"></button>
                                                        ${index === 0 ? '<span style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Main</span>' : ''}
                                                    </div>
                                                `).join('') : 
                                                (product.image_url ? `
                                                    <div class="image-item" style="position: relative; display: inline-block;">
                                                        <img src="${product.image_url}" alt="${product.name}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.src='../images/placeholder-product.svg'">
                                                        <span style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Main</span>
                                                    </div>
                                                ` : 'No images available')
                                            }
                                        </div>
                                        <button type="button" onclick="enableImageEdit()" style="padding: 5px 10px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer;">
                                            <i class="fas fa-plus"></i> Add/Edit Images
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                                    <button type="button" onclick="closeProductModal()" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
                                    <button type="submit" class="btn btn-primary" style="padding: 10px 20px; background: #007bff;">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading product for edit:', error);
                alert('Error loading product details. Please try again.');
            }
        }

        // Global storage for edit product images
        window.editProductNewImages = [];
        window.editProductRemovedImages = [];

        // Enable image editing
        function enableImageEdit() {
            document.getElementById('current-images-display').style.display = 'none';
            document.getElementById('new-image-section').style.display = 'block';
            // Reset new images array
            window.editProductNewImages = [];
            
            // Remove any existing paste counter
            const counter = document.querySelector('.paste-counter');
            if (counter) counter.remove();
        }

        // Cancel image editing
        function cancelImageEdit() {
            document.getElementById('current-images-display').style.display = 'block';
            document.getElementById('new-image-section').style.display = 'none';
            removeAllNewImages();
            // Reset tracking arrays
            window.editProductNewImages = [];
            window.editProductRemovedImages = [];
        }

        // Preview multiple product images
        // Preview multiple product images - No immediate preview, show counter instead
        function previewEditProductImages(input) {
            if (input.files && input.files.length > 0) {
                const files = Array.from(input.files);
                
                console.log(` File input: ${files.length} file(s) selected`);
                
                // Use the same logic as paste - no immediate preview
                handleImagePaste(files);
                
                // Clear the input so the same files can be selected again if needed
                input.value = '';
            }
        }

        // Update the preview display - Only call this when saving
        function updateNewImagesPreview() {
            const newImagesGrid = document.getElementById('new-images-grid');
            
            if (!newImagesGrid) {
                console.log(' new-images-grid not found');
                return;
            }
            
            if (window.editProductNewImages.length === 0) {
                document.getElementById('edit-images-preview').style.display = 'none';
                document.getElementById('edit-upload-placeholder').style.display = 'block';
                
                // Remove paste counter if exists
                const counter = document.querySelector('.paste-counter');
                if (counter) counter.remove();
                return;
            }
            
            // Show preview section
            document.getElementById('edit-images-preview').style.display = 'block';
            document.getElementById('edit-upload-placeholder').style.display = 'none';
            
            // Clear existing content
            newImagesGrid.innerHTML = '';
            
            // Add each new image to the grid
            window.editProductNewImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.style.cssText = 'position: relative; display: inline-block; margin-right: 10px; margin-bottom: 10px;';
                
                imageItem.innerHTML = `
                    <img src="${image.dataUrl}" alt="${image.name}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <button type="button" onclick="removeNewImageByIndex(${index})" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px;"></button>
                    <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 4px; border-radius: 4px; font-size: 10px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${image.name}</div>
                `;
                
                newImagesGrid.appendChild(imageItem);
            });
            
            console.log(` Updated preview with ${window.editProductNewImages.length} images`);
        }

        // Remove a specific new image by index
        function removeNewImageByIndex(index) {
            if (index >= 0 && index < window.editProductNewImages.length) {
                window.editProductNewImages.splice(index, 1);
                updateNewImagesPreview();
            }
        }

        // Remove all new images
        function removeAllNewImages() {
            window.editProductNewImages = [];
            document.getElementById('edit-product-images').value = '';
            document.getElementById('edit-images-preview').style.display = 'none';
            document.getElementById('edit-upload-placeholder').style.display = 'block';
            document.getElementById('new-images-grid').innerHTML = '';
            
            // Remove paste counter if exists
            const counter = document.querySelector('.paste-counter');
            if (counter) counter.remove();
        }

        // Remove existing image
        function removeExistingImage(index) {
            if (!window.editProductRemovedImages) {
                window.editProductRemovedImages = [];
            }
            window.editProductRemovedImages.push(index);
            
            // Hide the image visually
            event.target.parentElement.style.display = 'none';
        }

        // Add more images without replacing existing selection
        function addMoreImages() {
            document.getElementById('edit-product-images').click();
        }

        // Handle image paste functionality - Allow multiple pastes, show after save
        function handleImagePaste(files) {
            if (!files || files.length === 0) {
                console.log(' No files to process');
                return;
            }
            
            console.log(` Processing ${files.length} pasted image(s)`);
            
            // Check if edit images array exists
            if (!window.editProductNewImages) {
                window.editProductNewImages = [];
            }
            
            const existingCount = window.editProductNewImages.length;
            const maxAllowed = 10;
            const spacesAvailable = maxAllowed - existingCount;
            
            if (spacesAvailable <= 0) {
                alert('Maximum 10 images allowed. Please remove some images first before pasting more.');
                return;
            }
            
            if (files.length > spacesAvailable) {
                alert(`Maximum 10 images allowed. You can add ${spacesAvailable} more images. Only the first ${spacesAvailable} pasted images will be added.`);
            }
            
            const filesToProcess = Array.from(files).slice(0, spacesAvailable);
            let validFilesCount = 0;
            let processedCount = 0;
            const errors = [];
            
            console.log(` Will process ${filesToProcess.length} files`);
            
            filesToProcess.forEach((file, index) => {
                console.log(` Validating file ${index + 1}:`, file.name, file.type, `${(file.size / 1024 / 1024).toFixed(2)}MB`);
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    const errorMsg = `"${file.name || 'Image ' + (index + 1)}" is too large (${(file.size / 1024 / 1024).toFixed(2)}MB > 5MB)`;
                    errors.push(errorMsg);
                    console.log('', errorMsg);
                    
                    processedCount++;
                    if (processedCount === filesToProcess.length) {
                        showPasteResults(validFilesCount, errors);
                    }
                    return;
                }
                
                // Validate file type
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    const errorMsg = `"${file.name || 'Image ' + (index + 1)}" is not a valid image format (${file.type})`;
                    errors.push(errorMsg);
                    console.log('', errorMsg);
                    
                    processedCount++;
                    if (processedCount === filesToProcess.length) {
                        showPasteResults(validFilesCount, errors);
                    }
                    return;
                }
                
                validFilesCount++;
                console.log(` File ${index + 1} is valid, processing...`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Generate unique name to allow same image multiple times
                    const timestamp = Date.now();
                    const randomSuffix = Math.random().toString(36).substring(2, 8);
                    const fileName = file.name || `pasted-image.${file.type.split('/')[1]}`;
                    const uniqueName = fileName.replace(/(\.[^.]+)$/, `-${timestamp}-${randomSuffix}$1`);
                    
                    // Add to our global array
                    window.editProductNewImages.push({
                        dataUrl: e.target.result,
                        name: uniqueName,
                        size: file.size,
                        originalName: file.name || 'pasted-image'
                    });
                    
                    processedCount++;
                    console.log(` Processed file ${processedCount}/${filesToProcess.length}: ${uniqueName}`);
                    
                    // Don't update preview immediately - wait for save
                    if (processedCount === filesToProcess.length) {
                        console.log(' All files processed, ready to save');
                        showPasteResults(validFilesCount, errors);
                        updatePasteCounter(); // Show count instead of preview
                    }
                };
                
                reader.onerror = function() {
                    const errorMsg = `Failed to read "${file.name || 'Image ' + (index + 1)}"`;
                    errors.push(errorMsg);
                    console.log('', errorMsg);
                    
                    processedCount++;
                    if (processedCount === filesToProcess.length) {
                        showPasteResults(validFilesCount, errors);
                        updatePasteCounter();
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            if (validFilesCount === 0 && errors.length > 0) {
                showPasteResults(0, errors);
            }
        }

        // Show count of pasted images instead of preview
        function updatePasteCounter() {
            const placeholder = document.getElementById('edit-upload-placeholder');
            const existingCounter = placeholder.querySelector('.paste-counter');
            
            if (window.editProductNewImages && window.editProductNewImages.length > 0) {
                const count = window.editProductNewImages.length;
                
                if (existingCounter) {
                    existingCounter.textContent = ` ${count} image(s) ready to upload`;
                } else {
                    const counter = document.createElement('div');
                    counter.className = 'paste-counter';
                    counter.style.cssText = 'margin-top: 10px; padding: 8px 12px; background: #e3f2fd; color: #1565c0; border-radius: 4px; font-weight: 500;';
                    counter.textContent = ` ${count} image(s) ready to upload`;
                    placeholder.appendChild(counter);
                }
            } else if (existingCounter) {
                existingCounter.remove();
            }
        }

        // Show results of paste operation
        function showPasteResults(successCount, errors) {
            console.log(` Paste results: ${successCount} successful, ${errors.length} errors`);
            
            // Show success message (brief)
            if (successCount > 0) {
                const successMsg = successCount === 1 ? 
                    ` 1 image ready to upload` : 
                    ` ${successCount} images ready to upload`;
                
                console.log(successMsg);
                
                // Brief notification - don't show full alert unless there are errors
                if (errors.length === 0) {
                    // Just log success, no popup
                    return;
                }
            }
            
            // Show errors if any
            if (errors.length > 0) {
                const errorMsg = errors.length === 1 ? 
                    ` 1 image failed: ${errors[0]}` : 
                    ` ${errors.length} images failed:\n${errors.join('\n')}`;
                alert(errorMsg);
            }
        }

        // Handle drag and drop events
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = '#007bff';
            event.currentTarget.style.backgroundColor = 'rgba(0,123,255,0.1)';
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = '#007bff';
            event.currentTarget.style.backgroundColor = 'rgba(0,123,255,0.05)';
        }

        function handleImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Reset visual state
            event.currentTarget.style.borderColor = '#007bff';
            event.currentTarget.style.backgroundColor = 'rgba(0,123,255,0.05)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                console.log(` Dropped ${files.length} file(s)`);
                
                // Filter only image files
                const imageFiles = Array.from(files).filter(file => 
                    file.type.match(/^image\/(jpeg|jpg|png|gif)$/)
                );
                
                if (imageFiles.length === 0) {
                    alert('No valid image files found. Please drop JPG, PNG, or GIF files.');
                    return;
                }
                
                if (imageFiles.length < files.length) {
                    const nonImages = files.length - imageFiles.length;
                    alert(`${nonImages} non-image file(s) ignored. Processing ${imageFiles.length} image file(s).`);
                }
                
                handleImagePaste(imageFiles);
            }
        }

        // Initialize paste listener when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupPasteListener();
            console.log(' Initial paste listener setup completed');
        });
        
        // Also setup when window loads (backup)
        window.addEventListener('load', function() {
            setupPasteListener();
            console.log(' Backup paste listener setup completed');
        });

        // Save edited product using Supabase
        async function saveEditedProduct(event, productId) {
            event.preventDefault();
            
            try {
                const form = document.getElementById('edit-product-form');
                const formData = new FormData(form);
                
                // Get selected sizes
                const sizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
                
                if (sizes.length === 0) {
                    alert('Please select at least one size.');
                    return;
                }
                
                // Prepare update data with Supabase structure
                const updateData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    regular_price: parseFloat(formData.get('regular_price')),
                    stock_count: parseInt(formData.get('stock_count')),
                    description: formData.get('description') || '',
                    available_sizes: sizes,
                    in_stock: parseInt(formData.get('stock_count')) > 0
                };
                
                // Handle sale price
                const salePrice = formData.get('sale_price');
                if (salePrice && parseFloat(salePrice) > 0) {
                    updateData.sale_price = parseFloat(salePrice);
                    updateData.on_sale = true;
                } else {
                    updateData.sale_price = null;
                    updateData.on_sale = false;
                }
                
                console.log('Updating product with data:', updateData);
                
                // Update product in Supabase
                const success = await adminUpdateProduct(productId, updateData);
                if (success) {
                    alert('Product updated successfully in cloud database!\n\nChanges will be reflected across all devices instantly.');
                    closeProductModal();
                    await loadAdminProducts();
                } else {
                    alert('Failed to update product. Please try again.');
                }
                
            } catch (error) {
                console.error('Error saving edited product:', error);
                alert('Error updating product. Please try again.');
            }
        }

        function showAddProductForm() {
            // Create a more comprehensive product form with image upload
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; width: 90%;">
                    <div class="modal-header">
                        <h3><i class="fas fa-plus"></i> Add New Product</h3>
                        <button type="button" class="modal-close" onclick="closeProductModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="product-form" onsubmit="saveNewProduct(event)">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="product-name">Product Name *</label>
                                    <input type="text" id="product-name" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-category">Category *</label>
                                    <select id="product-category" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="briefs">Briefs</option>
                                        <option value="trunks">Trunks</option>
                                        <option value="tie-dye">Tie-Dye</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="product-regular-price">Regular Price () *</label>
                                    <input type="number" id="product-regular-price" name="regularPrice" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-sale-price">Sale Price ()</label>
                                    <input type="number" id="product-sale-price" name="salePrice" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="product-stock">Stock Count *</label>
                                    <input type="number" id="product-stock" name="stockCount" min="0" value="50" required>
                                </div>
                                <div class="form-group">
                                    <label>Available Sizes</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                                        <label><input type="checkbox" name="sizes" value="S" checked> S</label>
                                        <label><input type="checkbox" name="sizes" value="M" checked> M</label>
                                        <label><input type="checkbox" name="sizes" value="L" checked> L</label>
                                        <label><input type="checkbox" name="sizes" value="XL" checked> XL</label>
                                        <label><input type="checkbox" name="sizes" value="XXL"> XXL</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="product-description">Description</label>
                                <textarea id="product-description" name="description" rows="3" placeholder="Enter product description..."></textarea>
                            </div>
                            
                            <!-- Image Upload Section -->
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Product Image</label>
                                <div class="image-upload-container" style="border: 2px dashed #007bff; border-radius: 8px; padding: 20px; text-align: center; margin-top: 10px; background: rgba(0,123,255,0.05); cursor: pointer;" 
                                     onclick="document.getElementById('product-image').click()"
                                     ondrop="handleNewProductImageDrop(event)" 
                                     ondragover="handleDragOver(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <input type="file" id="product-image" accept="image/*" style="display: none;" onchange="previewProductImage(this)">
                                    <div id="image-preview" style="margin-bottom: 15px; display: none;">
                                        <img id="preview-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <button type="button" onclick="removeImagePreview()" style="display: block; margin: 10px auto; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                                    </div>
                                    <div id="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #666; margin-bottom: 10px;"></i>
                                        <p style="margin: 0; color: #666;">Click to select, drag & drop, or <strong>Ctrl+V to paste</strong> image</p>
                                        <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #999;">Supports JPG, PNG, GIF (Max 5MB)</p>
                                        <button type="button" onclick="event.stopPropagation(); document.getElementById('product-image').click()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Choose File</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                                <button type="button" onclick="closeProductModal()" style="padding: 10px 20px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup paste listener for this modal
            setupPasteListener();
            console.log(' Paste listener activated for add product modal');
        }

        // Preview product image
        function previewProductImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please choose an image smaller than 5MB.');
                    input.value = '';
                    return;
                }
                
                // Validate file type
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    alert('Please select a valid image file (JPG, PNG, or GIF).');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove image preview
        function removeImagePreview() {
            document.getElementById('product-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('upload-placeholder').style.display = 'block';
        }

        // Handle drag and drop for new product image
        function handleNewProductImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Reset visual state
            event.currentTarget.style.borderColor = '#007bff';
            event.currentTarget.style.backgroundColor = 'rgba(0,123,255,0.05)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0]; // Only take first file for single image upload
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please choose an image smaller than 5MB.');
                    return;
                }
                
                // Validate file type
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    alert('Please select a valid image file (JPG, PNG, or GIF).');
                    return;
                }
                
                // Create a FileList-like object and assign to input
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('product-image').files = dt.files;
                
                // Preview the image
                previewProductImage(document.getElementById('product-image'));
            }
        }

        // Enhanced paste listener that handles multiple consecutive pastes
        function setupPasteListener() {
            // Remove any existing paste listeners to avoid duplicates
            document.removeEventListener('paste', handlePasteEvent);
            
            // Add the paste event listener
            document.addEventListener('paste', handlePasteEvent);
        }

        // Separate paste event handler function
        function handlePasteEvent(event) {
            console.log(' Paste event triggered');
            
            // Check if we're in the edit modal context (supports multiple images)
            if (document.getElementById('edit-upload-placeholder') && 
                document.getElementById('edit-upload-placeholder').offsetParent !== null) {
                
                console.log(' In edit modal context');
                
                const items = event.clipboardData.items;
                const imageFiles = [];
                
                // Check for regular image items
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf('image') !== -1) {
                        const file = item.getAsFile();
                        if (file) {
                            imageFiles.push(file);
                            console.log(' Found image item:', file.name, file.type);
                        }
                    }
                }
                
                // Also check for files (for multiple image paste from file explorer)
                if (event.clipboardData.files && event.clipboardData.files.length > 0) {
                    const files = Array.from(event.clipboardData.files);
                    console.log(' Found clipboard files:', files.length);
                    files.forEach(file => {
                        if (file.type.indexOf('image') !== -1) {
                            // Avoid duplicates
                            const alreadyAdded = imageFiles.some(existing => 
                                existing.name === file.name && existing.size === file.size && existing.lastModified === file.lastModified
                            );
                            if (!alreadyAdded) {
                                imageFiles.push(file);
                                console.log(' Added file:', file.name, file.type);
                            }
                        }
                    });
                }
                
                if (imageFiles.length > 0) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log(` Processing ${imageFiles.length} image(s) for edit modal`);
                    handleImagePaste(imageFiles);
                    return; // Exit early to prevent other handlers
                }
            }
            
            // Check if we're in the new product form context (single image)
            if (document.getElementById('upload-placeholder') && 
                document.getElementById('upload-placeholder').offsetParent !== null &&
                document.getElementById('product-image')) {
                
                console.log(' In new product form context');
                
                const items = event.clipboardData.items;
                const imageFiles = [];
                
                // Check for regular image items
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf('image') !== -1) {
                        const file = item.getAsFile();
                        if (file) {
                            imageFiles.push(file);
                        }
                    }
                }
                
                // Also check clipboard files
                if (event.clipboardData.files && event.clipboardData.files.length > 0) {
                    const files = Array.from(event.clipboardData.files);
                    files.forEach(file => {
                        if (file.type.indexOf('image') !== -1) {
                            const alreadyAdded = imageFiles.some(existing => 
                                existing.name === file.name && existing.size === file.size && existing.lastModified === file.lastModified
                            );
                            if (!alreadyAdded) {
                                imageFiles.push(file);
                            }
                        }
                    });
                }
                
                if (imageFiles.length > 0) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // For new product form, take the first image only but inform user
                    const imageFile = imageFiles[0];
                    if (imageFiles.length > 1) {
                        alert(`You pasted ${imageFiles.length} images. Only the first image "${imageFile.name}" will be used for the new product. Use the Edit Product feature to add multiple images.`);
                    }
                    
                    // Validate file size (5MB max)
                    if (imageFile.size > 5 * 1024 * 1024) {
                        alert('Pasted image is too large. Please use images smaller than 5MB.');
                        return;
                    }
                    
                    // Validate file type
                    if (!imageFile.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                        alert('Pasted file is not a valid image. Please use JPG, PNG, or GIF files.');
                        return;
                    }
                    
                    // Create a FileList-like object and assign to input
                    const dt = new DataTransfer();
                    dt.items.add(imageFile);
                    document.getElementById('product-image').files = dt.files;
                    
                    // Preview the image
                    previewProductImage(document.getElementById('product-image'));
                    return; // Exit early to prevent other handlers
                }
            }
        }

        // Close product modal
        function closeProductModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Save new product using Supabase
        async function saveNewProduct(event) {
            event.preventDefault();
            
            try {
                const form = document.getElementById('product-form');
                const formData = new FormData(form);
                
                // Get selected sizes
                const sizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
                
                if (sizes.length === 0) {
                    alert('Please select at least one size.');
                    return;
                }
                
                // Prepare product data with Supabase structure
                const productData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    regular_price: parseFloat(formData.get('regularPrice')),
                    sale_price: formData.get('salePrice') ? parseFloat(formData.get('salePrice')) : null,
                    stock_count: parseInt(formData.get('stockCount')),
                    description: formData.get('description') || '',
                    image_url: '../images/products/default.jpg', // Default image for now
                    available_sizes: sizes,
                    in_stock: parseInt(formData.get('stockCount')) > 0,
                    on_sale: !!(formData.get('salePrice') && parseFloat(formData.get('salePrice')) > 0)
                };
                
                console.log('Adding new product to Supabase:', productData);
                
                const success = await adminAddProduct(productData);
                if (success) {
                    alert('Product added successfully to cloud database!\n\nNew product will appear on all devices instantly.');
                    closeProductModal();
                    await loadAdminProducts();
                } else {
                    alert('Failed to add product. Please try again.');
                }
                
            } catch (error) {
                console.error('Error saving new product:', error);
                alert('Error adding product. Please try again.');
            }
        }

        // Admin Product Management Functions using Supabase
        async function adminUpdateProduct(productId, updates) {
            try {
                if (!window.supabaseDB) {
                    alert('Database connection not available. Please refresh the page.');
                    return false;
                }
                
                console.log('Updating product in Supabase:', productId, updates);
                const success = await window.supabaseDB.updateProduct(productId, updates);
                
                if (success) {
                    console.log('Product updated successfully in cloud database:', productId, updates);
                    
                    // Trigger a custom event to notify all clients about the update
                    if (typeof window !== 'undefined') {
                        window.dispatchEvent(new CustomEvent('productUpdated', {
                            detail: { productId, updates }
                        }));
                    }
                    
                    return true;
                }
                
                console.error('Failed to update product in Supabase');
                return false;
                
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Error updating product. Please try again.');
                return false;
            }
        }

        // Update product price from admin using Supabase
        async function adminUpdateProductPrice(productId, newPrice, isRegularPrice = true) {
            try {
                const updates = {};
                if (isRegularPrice) {
                    updates.regular_price = parseFloat(newPrice);
                } else {
                    updates.sale_price = parseFloat(newPrice);
                }
                
                return await adminUpdateProduct(productId, updates);
                
            } catch (error) {
                console.error('Error updating product price:', error);
                return false;
            }
        }

        // Update product stock from admin using Supabase
        async function adminUpdateProductStock(productId, newStock) {
            try {
                const updates = {
                    stock_count: parseInt(newStock),
                    in_stock: parseInt(newStock) > 0
                };
                
                return await adminUpdateProduct(productId, updates);
                
            } catch (error) {
                console.error('Error updating product stock:', error);
                return false;
            }
        }

        // Toggle product sale status from admin using Supabase
        async function adminToggleProductSale(productId, onSale) {
            try {
                const updates = { on_sale: onSale };
                return await adminUpdateProduct(productId, updates);
                
            } catch (error) {
                console.error('Error toggling product sale:', error);
                return false;
            }
        }

        // Get all products for admin display using Supabase
        async function adminGetAllProducts() {
            try {
                if (!window.supabaseDB) return [];
                return await window.supabaseDB.getAllProducts();
                
            } catch (error) {
                console.error('Error getting all products:', error);
                return [];
            }
        }

        // Add new product from admin using Supabase
        async function adminAddProduct(productData) {
            try {
                if (!window.supabaseDB) {
                    alert('Database connection not available. Please refresh the page.');
                    return false;
                }
                
                // Convert form data to Supabase structure
                const newProduct = {
                    name: productData.name,
                    regular_price: parseFloat(productData.regular_price || productData.regularPrice),
                    sale_price: productData.sale_price || productData.salePrice ? parseFloat(productData.sale_price || productData.salePrice) : null,
                    on_sale: !!(productData.sale_price || productData.salePrice),
                    image_url: productData.image_url || productData.image || '../images/products/default.jpg',
                    gallery_images: productData.gallery_images || productData.images || [],
                    category: productData.category,
                    description: productData.description || '',
                    in_stock: true,
                    stock_count: parseInt(productData.stock_count || productData.stockCount) || 0,
                    available_sizes: productData.available_sizes || productData.availableSizes || ['S', 'M', 'L', 'XL']
                };
                
                console.log('Adding product to Supabase:', newProduct);
                const success = await window.supabaseDB.addProduct(newProduct);
                
                if (success) {
                    console.log('New product added to cloud database:', newProduct);
                    
                    // Trigger a custom event to notify all clients about the new product
                    if (typeof window !== 'undefined') {
                        window.dispatchEvent(new CustomEvent('productAdded', {
                            detail: { product: newProduct }
                        }));
                    }
                    
                    return true;
                }
                
                console.error('Failed to add product to Supabase');
                return false;
                
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Error adding product. Please try again.');
                return false;
            }
        }

        // Delete product from admin using Supabase
        async function adminDeleteProduct(productId) {
            try {
                if (!window.supabaseDB) {
                    alert('Database connection not available. Please refresh the page.');
                    return false;
                }
                
                console.log('Deleting product from Supabase:', productId);
                const success = await window.supabaseDB.deleteProduct(productId);
                
                if (success) {
                    console.log('Product deleted from cloud database:', productId);
                    
                    // Trigger a custom event to notify all clients about the deletion
                    if (typeof window !== 'undefined') {
                        window.dispatchEvent(new CustomEvent('productDeleted', {
                            detail: { productId }
                        }));
                    }
                    
                    return true;
                }
                
                console.error('Failed to delete product from Supabase');
                return false;
                
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product. Please try again.');
                return false;
            }
        }

        // Reset products to defaults from admin
        function adminResetProducts() {
            if (confirm('This will reset all products to default values. Are you sure?')) {
                if (window.productManager) {
                    window.productManager.resetToDefaults();
                    updateProductStats();
                    
                    // Trigger storage event to notify main site
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'bumable_products',
                        newValue: JSON.stringify(window.productManager.getAllProducts())
                    }));
                    
                    alert('Products reset to defaults successfully!');
                }
            }
        }

        // Export products data
        async function adminExportProducts() {
            if (!window.productManager) return;
            
            const products = await window.productManager.getAllProducts();
            const dataStr = JSON.stringify(products, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bumable-products-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Products exported successfully!');
        }

        // Manual sync function for testing
        async function forceSyncProducts() {
            console.log('Force syncing products...');
            
            // Check if ProductManager exists
            if (!window.ProductManager) {
                console.error('ProductManager class not available');
                alert('ProductManager not loaded. Please refresh the page.');
                return;
            }
            
            // Reinitialize product manager
            window.productManager = new ProductManager();
            await window.productManager.init();
            console.log('Product manager reinitialized');
            const products = await window.productManager.getAllProducts();
            console.log('Products found:', products.length);
            
            // Update displays
            updateProductStats();
            loadAdminProducts();
            
            // Products are now managed entirely in Supabase - no localStorage cache needed
            console.log(` Products synchronized successfully! Found ${products.length} products in Supabase.`);
            
            alert(`Products synchronized successfully! Found ${products.length} products.`);
        }
        
        // ===== CUSTOMER MANAGEMENT FUNCTIONS =====
        
        // Load customers data from Supabase cloud database (Enhanced with device tracking)
        async function loadCustomersData() {
            console.log('Loading customers data with device tracking from cloud database...');
            
            try {
                if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                    console.log('Supabase not ready, showing empty customer list');
                    displayCustomers([]);
                    return;
                }

                // Get all users and their activity logs from Supabase
                const usersResult = await window.supabaseDB.getAllUsers();
                const ordersResult = await window.supabaseDB.getAllOrders();
                const activityResult = await window.supabaseDB.getAllUserActivities();
                
                const users = usersResult.success ? usersResult.users : [];
                const orders = ordersResult.success ? ordersResult.orders : [];
                const activities = activityResult.success ? activityResult.activities : [];
                
                console.log('Found users:', users.length);
                console.log('Found orders:', orders.length);
                console.log('Found activities:', activities.length);
                
                // Process users and calculate enhanced customer data
                const customerMap = {};
                
                users.forEach(user => {
                    // Calculate customer's orders and total spent
                    const customerOrders = orders.filter(order => order.customer_email === user.email);
                    const totalSpent = customerOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                    
                    // Get user's activity history
                    const userActivities = activities.filter(activity => activity.email === user.email);
                    const loginActivities = userActivities.filter(activity => 
                        activity.activity_type === 'successful_login' || 
                        activity.activity_type === 'failed_login'
                    );
                    
                    // Get last login info with device details
                    const lastLoginActivity = loginActivities
                        .filter(activity => activity.activity_type === 'successful_login')
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                    
                    const lastDeviceInfo = lastLoginActivity ? lastLoginActivity.device_info : null;
                    
                    customerMap[user.email] = {
                        id: user.id,
                        name: `${user.first_name} ${user.last_name}`,
                        firstName: user.first_name,
                        lastName: user.last_name,
                        email: user.email,
                        phone: user.phone || 'N/A',
                        registrationDate: user.created_at,
                        lastLogin: lastLoginActivity ? lastLoginActivity.timestamp : user.created_at,
                        loginCount: loginActivities.filter(a => a.activity_type === 'successful_login').length,
                        failedLoginCount: loginActivities.filter(a => a.activity_type === 'failed_login').length,
                        isRegistered: true,
                        isActive: user.status === 'active',
                        marketingConsent: user.marketing_consent || false,
                        orders: customerOrders.length,
                        totalSpent: totalSpent,
                        // Enhanced device and session tracking
                        lastDeviceInfo: lastDeviceInfo,
                        lastIpAddress: lastLoginActivity ? lastLoginActivity.ip_address : 'Unknown',
                        registrationDevice: user.device_info || null,
                        activityHistory: userActivities.slice(0, 10), // Last 10 activities
                        status: user.status || 'active',
                        firstOrder: customerOrders.length > 0 ? customerOrders[customerOrders.length - 1].created_at : null,
                        lastOrder: customerOrders.length > 0 ? customerOrders[0].created_at : null,
                        customerType: totalSpent > 5000 ? 'premium' : (customerOrders.length > 0 ? 'returning' : 'new')
                    };
                });
                
                // Add guest customers from orders (customers who ordered without registering)
                orders.forEach(order => {
                    const customerId = order.customer_email || order.customer_phone || order.id;
                    const customerName = `${order.customer_first_name || ''} ${order.customer_last_name || ''}`.trim();
                    
                    if (!customerMap[customerId] && order.customer_email) {
                        // Create guest customer entry
                        customerMap[customerId] = {
                            id: customerId,
                            name: customerName || 'Guest Customer',
                            email: order.customer_email || 'N/A',
                            phone: order.customer_phone || 'N/A',
                            registrationDate: null,
                            lastLogin: null,
                            loginCount: 0,
                            isRegistered: false,
                            isActive: true,
                            marketingConsent: false,
                            orders: 1,
                            totalSpent: order.total || 0,
                            firstOrder: order.created_at,
                            lastOrder: order.created_at,
                            customerType: 'guest'
                        };
                    } else {
                        // Update existing customer's order stats
                        const customer = customerMap[customerId];
                        customer.orders += 1;
                        customer.totalSpent += order.total || 0;
                        
                        // Update order dates
                        if (!customer.firstOrder || new Date(order.created_at) < new Date(customer.firstOrder)) {
                            customer.firstOrder = order.created_at;
                        }
                        if (!customer.lastOrder || new Date(order.created_at) > new Date(customer.lastOrder)) {
                            customer.lastOrder = order.created_at;
                        }
                    }
                });
                
                const customers = Object.values(customerMap);
                console.log('Processed customers:', customers.length);
                
                // Update customer stats and display
                await updateCustomerStats(customers);
                displayCustomers(customers);
                
            } catch (error) {
                console.error('Error loading customers data:', error);
                displayCustomers([]);
            }
        }
        
        // Update customer statistics
        async function updateCustomerStats(customers) {
            try {
                // Get contact queries from Supabase
                let contactCustomers = 0;
                let recentRegistrations = 0;
                let newContactCustomers = 0;
                
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const contactsResult = await window.supabaseDB.getAllContacts();
                    if (contactsResult.success) {
                        const uniqueContactEmails = [...new Set(contactsResult.contacts.map(q => q.email))];
                        contactCustomers = uniqueContactEmails.length;
                        
                        // Calculate new contact customers this month
                        const currentMonth = new Date().getMonth();
                        const currentYear = new Date().getFullYear();
                        newContactCustomers = contactsResult.contacts.filter(query => {
                            const queryDate = new Date(query.created_at || query.timestamp);
                            return queryDate.getMonth() === currentMonth && queryDate.getFullYear() === currentYear;
                        }).length;
                    }
                }
                
                // Separate registered and guest customers
                const registeredCustomers = customers.filter(c => c.isRegistered);
                const guestCustomers = customers.filter(c => !c.isRegistered);
                
                // Calculate totals
                const totalCustomers = customers.length + Math.max(0, contactCustomers - customers.filter(c => c.email !== 'N/A').length);
                const totalRegistered = registeredCustomers.length;
                const totalGuests = guestCustomers.length;
                const totalOrders = customers.reduce((sum, c) => sum + c.orders, 0);
                const totalValue = customers.reduce((sum, c) => sum + c.totalSpent, 0);
                
                // Calculate recent registrations (last 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                recentRegistrations = registeredCustomers.filter(customer => 
                    customer.registrationDate && new Date(customer.registrationDate) > sevenDaysAgo
                ).length;
                
                // Calculate new customers this month
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // New registrations this month
                const newRegistrations = registeredCustomers.filter(customer => {
                    if (!customer.registrationDate) return false;
                    const regDate = new Date(customer.registrationDate);
                    return regDate.getMonth() === currentMonth && regDate.getFullYear() === currentYear;
                }).length;
                
                // New order customers this month
                const newOrderCustomers = customers.filter(customer => {
                    if (!customer.firstOrder) return false;
                    const firstOrder = new Date(customer.firstOrder);
                    return firstOrder.getMonth() === currentMonth && firstOrder.getFullYear() === currentYear;
                }).length;
                
                const newCustomers = Math.max(newRegistrations, newOrderCustomers, newContactCustomers);
                
                // Update UI with enhanced customer stats
                document.getElementById('customers-total').textContent = totalCustomers;
                document.getElementById('customers-new').textContent = newCustomers;
                
                // Update additional customer metrics if elements exist
                const registeredCountEl = document.getElementById('customers-registered');
                const guestsCountEl = document.getElementById('customers-guests');
                const recentLoginsEl = document.getElementById('recent-logins');
                const recentRegEl = document.getElementById('recent-registrations');
                
                if (registeredCountEl) registeredCountEl.textContent = totalRegistered;
                if (guestsCountEl) guestsCountEl.textContent = totalGuests;
                if (recentLoginsEl) recentLoginsEl.textContent = customers.reduce((sum, c) => sum + (c.loginCount || 0), 0);
                if (recentRegEl) recentRegEl.textContent = recentRegistrations;
                document.getElementById('customers-orders').textContent = totalOrders;
                document.getElementById('customers-value').textContent = `${totalValue.toLocaleString('en-IN')}`;
            } catch (error) {
                console.error('Error updating customer stats:', error);
            }
        }

        // Update contact queries statistics
        async function updateQueriesStats() {
            try {
                let queries = [];
                
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const result = await window.supabaseDB.getAllContacts();
                    if (result.success) {
                        queries = result.contacts;
                    }
                }
                
                // Calculate stats
                const totalQueries = queries.length;
                const pendingQueries = queries.filter(q => q.status === 'new' || q.status === 'pending').length;
                const repliedQueries = queries.filter(q => q.status === 'replied' || q.status === 'resolved').length;
                
                // Calculate queries today
                const today = new Date();
                const todayQueries = queries.filter(query => {
                    const queryDate = new Date(query.created_at || query.timestamp);
                    return queryDate.toDateString() === today.toDateString();
                }).length;
                
                // Update UI
                document.getElementById('queries-total').textContent = totalQueries;
                document.getElementById('queries-pending').textContent = pendingQueries;
                document.getElementById('queries-replied').textContent = repliedQueries;
                document.getElementById('queries-today').textContent = todayQueries;
            } catch (error) {
                console.error('Error updating queries stats:', error);
            }
        }
        
        // Display customers in table
        function displayCustomers(customers) {
            const tbody = document.getElementById('admin-customers-tbody');
            
            if (!customers || customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-orders">No customers found</td></tr>';
                return;
            }

            // Sort by total spent (highest first)
            customers.sort((a, b) => b.totalSpent - a.totalSpent);

            tbody.innerHTML = customers.map(customer => {
                const lastOrderDate = customer.lastOrder ? new Date(customer.lastOrder).toLocaleDateString('en-IN') : 'N/A';
                const registrationDate = customer.registrationDate ? new Date(customer.registrationDate).toLocaleDateString('en-IN') : 'N/A';
                const lastLoginDate = customer.lastLogin ? new Date(customer.lastLogin).toLocaleDateString('en-IN') : 'N/A';
                const lastLoginTime = customer.lastLogin ? new Date(customer.lastLogin).toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : 'N/A';
                
                // Customer status badge
                let statusBadge = '';
                let statusClass = '';
                
                if (customer.isRegistered) {
                    statusBadge = customer.isActive ? 'Registered' : 'Inactive';
                    statusClass = customer.isActive ? 'status-confirmed' : 'status-cancelled';
                } else {
                    statusBadge = 'Guest';
                    statusClass = 'status-pending';
                }
                
                // Device and location info
                const deviceInfo = customer.deviceInfo || {};
                const lastDevice = deviceInfo.deviceType || 'Unknown';
                const lastBrowser = deviceInfo.browser || 'Unknown';
                const lastOS = deviceInfo.os || 'Unknown';
                const ipAddress = customer.ipAddress || 'N/A';
                const location = customer.location || 'N/A';
                
                // Format device info display
                const deviceDisplay = lastDevice !== 'Unknown' ? 
                    `${lastDevice} (${lastBrowser})` : 'No device data';
                
                return `
                    <tr>
                        <td>
                            <div class="customer-name">
                                <strong>${customer.name}</strong>
                                ${customer.isRegistered ? '<i class="fas fa-user-check" style="color: #28a745; margin-left: 5px;" title="Registered User"></i>' : '<i class="fas fa-user" style="color: #6c757d; margin-left: 5px;" title="Guest User"></i>'}
                            </div>
                            <div class="customer-info">
                                <span class="status-badge ${statusClass}">${statusBadge}</span>
                                <span class="customer-type">${customer.customerType}</span>
                            </div>
                        </td>
                        <td>
                            <div><strong>${customer.email}</strong></div>
                            ${customer.registrationDate ? `<small style="color: #666;"><i class="fas fa-calendar-plus"></i> Joined: ${registrationDate}</small>` : ''}
                        </td>
                        <td>
                            <div><strong>${customer.phone}</strong></div>
                            ${customer.isRegistered ? `<small style="color: #666;"><i class="fas fa-sign-in-alt"></i> Logins: ${customer.loginCount}</small>` : ''}
                        </td>
                        <td>
                            <div class="device-info">
                                <div><i class="fas fa-desktop" style="color: #007bff;"></i> ${deviceDisplay}</div>
                                <small style="color: #666;">
                                    <i class="fas fa-globe"></i> ${ipAddress}
                                    ${location !== 'N/A' ? `| ${location}` : ''}
                                </small>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-confirmed">${customer.orders}</span>
                        </td>
                        <td class="order-total">${customer.totalSpent.toLocaleString('en-IN')}</td>
                        <td>
                            <div>${lastOrderDate}</div>
                            ${customer.lastLogin ? `
                                <small style="color: #666;">
                                    <i class="fas fa-clock"></i> Last login: ${lastLoginDate} at ${lastLoginTime}
                                </small>
                            ` : '<small style="color: #999;">Never logged in</small>'}
                        </td>
                        <td>
                            <button class="action-btn btn-primary" onclick="viewCustomerDetails('${customer.id}')" title="View Customer Details & Login History">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-success" onclick="viewCustomerOrders('${customer.id}')" title="View Orders">
                                <i class="fas fa-shopping-bag"></i>
                            </button>
                            <button class="action-btn btn-info" onclick="viewDeviceHistory('${customer.id}')" title="View Device & Login History">
                                <i class="fas fa-history"></i>
                            </button>
                            ${customer.isRegistered ? `
                                <button class="action-btn ${customer.isActive ? 'btn-warning' : 'btn-info'}" onclick="toggleCustomerStatus('${customer.id}')" title="${customer.isActive ? 'Deactivate' : 'Activate'} Account">
                                    <i class="fas fa-${customer.isActive ? 'ban' : 'check'}"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn btn-danger" onclick="deleteCustomer('${customer.id}')" title="Delete Customer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // View customer details (deprecated - data now in Supabase)
        function viewCustomerDetails(customerId) {
            alert('Customer details are now managed in Supabase. Please view customer orders through the Customers section.');
        }
        
        // Toggle customer account status (deprecated)
        function toggleCustomerStatus(customerId) {
            alert('User status management is now handled through the Supabase database.');
        }
        
        // Toggle user active status (deprecated - managed in Supabase)
        async function toggleUserStatus(customerId) {
            alert('User status management is now handled through the Supabase database. Please use the Supabase dashboard to manage user accounts.');
            // This function would need to be implemented with proper Supabase user management
            // For now, it's disabled to prevent localStorage usage
        }
        
        // View customer orders
        async function viewCustomerOrders(customerId) {
            if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                alert('Database not connected.');
                return;
            }
            
            const result = await window.supabaseDB.getAllOrders();
            if (!result.success) {
                alert('Failed to load orders.');
                return;
            }
            
            const customerOrders = result.orders.filter(order => 
                order.customer_email === customerId || order.id === customerId
            );
            
            if (customerOrders.length === 0) {
                alert('No orders found for this customer.');
                return;
            }
            
            const ordersList = customerOrders.map(order => {
                const orderDate = new Date(order.created_at || order.orderDate).toLocaleDateString('en-IN');
                const itemCount = order.items ? order.items.length : 0;
                return ` Order ${order.order_number || order.orderId} - ${orderDate} - ${itemCount} items - ${(order.total_amount || order.total || 0).toLocaleString('en-IN')}`;
            }).join('\n');
            
            alert(`Customer Orders:\n\n${ordersList}`);
        }
        
        // View customer device and login history
        async function viewDeviceHistory(customerId) {
            try {
                if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                    alert('Database not connected.');
                    return;
                }
                
                // Get user activities from Supabase
                const result = await window.supabaseDB.getAllUserActivities();
                
                let activities = [];
                if (result.success) {
                    activities = result.activities.filter(activity => 
                        activity.user_email === customerId || activity.user_id === customerId
                    ).slice(0, 10);
                }
                
                if (activities.length === 0) {
                    alert('No device or login history found for this customer.');
                    return;
                }
                
                let historyInfo = `CUSTOMER DEVICE & LOGIN HISTORY\n`;
                historyInfo += `=====================================\n\n`;
                
                // Customer basic info
                if (customerOrders.length > 0) {
                    const customer = customerOrders[0];
                    historyInfo += `Customer: ${customer.firstName || ''} ${customer.lastName || ''}\n`;
                    historyInfo += `Email: ${customer.email || 'N/A'}\n`;
                    historyInfo += `Phone: ${customer.phone || 'N/A'}\n\n`;
                }
                
                // Login Activities
                if (activities && activities.length > 0) {
                    historyInfo += `RECENT LOGIN ACTIVITIES:\n`;
                    historyInfo += `-------------------------\n`;
                    
                    activities.forEach((activity, index) => {
                        const date = new Date(activity.created_at).toLocaleDateString('en-IN');
                        const time = new Date(activity.created_at).toLocaleTimeString('en-IN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        historyInfo += `${index + 1}. ${activity.activity_type || 'Login'} - ${date} at ${time}\n`;
                        
                        if (activity.device_info) {
                            const device = typeof activity.device_info === 'string' 
                                ? JSON.parse(activity.device_info) 
                                : activity.device_info;
                                
                            historyInfo += `   Device: ${device.deviceType || 'Unknown'}\n`;
                            historyInfo += `   Browser: ${device.browser || 'Unknown'} (${device.browserVersion || 'Unknown'})\n`;
                            historyInfo += `   OS: ${device.os || 'Unknown'} (${device.osVersion || 'Unknown'})\n`;
                            historyInfo += `   Screen: ${device.screenResolution || 'Unknown'}\n`;
                            historyInfo += `   Timezone: ${device.timezone || 'Unknown'}\n`;
                        }
                        
                        if (activity.ip_address) {
                            historyInfo += `   IP Address: ${activity.ip_address}\n`;
                        }
                        
                        if (activity.location) {
                            historyInfo += `   Location: ${activity.location}\n`;
                        }
                        
                        historyInfo += `\n`;
                    });
                } else {
                    historyInfo += `DEVICE INFORMATION:\n`;
                    historyInfo += `-------------------\n`;
                    historyInfo += `No login activities found in database.\n`;
                    historyInfo += `This customer may have only placed orders without logging in.\n\n`;
                }
                
                // Order history summary
                if (customerOrders.length > 0) {
                    historyInfo += `ORDER HISTORY SUMMARY:\n`;
                    historyInfo += `----------------------\n`;
                    historyInfo += `Total Orders: ${customerOrders.length}\n`;
                    
                    const totalSpent = customerOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                    historyInfo += `Total Spent: ${totalSpent.toLocaleString('en-IN')}\n`;
                    
                    const firstOrderDate = new Date(Math.min(...customerOrders.map(o => new Date(o.orderDate)))).toLocaleDateString('en-IN');
                    const lastOrderDate = new Date(Math.max(...customerOrders.map(o => new Date(o.orderDate)))).toLocaleDateString('en-IN');
                    
                    historyInfo += `First Order: ${firstOrderDate}\n`;
                    historyInfo += `Last Order: ${lastOrderDate}\n`;
                }
                
                // Create modal for better display
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; padding: 20px; border-radius: 10px;
                    max-width: 600px; max-height: 80%; overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                
                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333;">Customer Device & Login History</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <pre style="font-size: 12px; line-height: 1.4; white-space: pre-wrap; color: #333;">${historyInfo}</pre>
                `;
                
                modal.className = 'modal';
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Close on background click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
            } catch (error) {
                console.error('Error viewing device history:', error);
                alert('Error loading device history. Please try again.');
            }
        }
        
        // Refresh customers data
        function refreshCustomersData() {
            loadCustomersData();
            alert('Customer data refreshed!');
        }
        
        // Export customers data
        async function exportCustomersData() {
            if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                alert('Database not connected. Cannot export customers.');
                return;
            }
            
            try {
                const orders = await window.supabaseDB.getAllOrders();
                
                if (orders.length === 0) {
                    alert('No customer data to export.');
                    return;
                }
                
                // Create CSV content
                const csvHeaders = ['Customer Name', 'Email', 'Phone', 'Device Info', 'Orders Count', 'Total Spent', 'First Order', 'Last Order'];
                const customerMap = {};
                
                // Process orders to get customer data
                orders.forEach(order => {
                    const customerId = order.email || order.phone || order.orderId || order.order_id;
                    const customerName = (order.firstName || order.first_name || '') + ' ' + (order.lastName || order.last_name || '');
                    
                    if (!customerMap[customerId]) {
                        customerMap[customerId] = {
                            name: customerName.trim() || 'Guest Customer',
                            email: order.email || 'N/A',
                            phone: order.phone || 'N/A',
                            orders: 0,
                            totalSpent: 0,
                            firstOrder: order.orderDate || order.order_date,
                            lastOrder: order.orderDate || order.order_date
                        };
                    }
                    
                    customerMap[customerId].orders += 1;
                    customerMap[customerId].totalSpent += order.total || 0;
                    
                    const orderDate = order.orderDate || order.order_date;
                    if (new Date(orderDate) < new Date(customerMap[customerId].firstOrder)) {
                        customerMap[customerId].firstOrder = orderDate;
                    }
                    if (new Date(orderDate) > new Date(customerMap[customerId].lastOrder)) {
                        customerMap[customerId].lastOrder = orderDate;
                    }
                });
                
                const customers = Object.values(customerMap);
                
                const csvData = customers.map(customer => [
                    customer.name,
                    customer.email,
                    customer.phone,
                    customer.orders,
                    customer.totalSpent,
                    new Date(customer.firstOrder).toLocaleDateString('en-IN'),
                    new Date(customer.lastOrder).toLocaleDateString('en-IN')
                ]);
            
            const csvContent = [csvHeaders, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bumable-customers-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Customer data exported successfully!');
            } catch (error) {
                console.error('Error exporting customers:', error);
                alert('Failed to export customer data. Please try again.');
            }
        }
        
        // Export Orders Data to CSV
        async function exportOrdersData() {
            if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                alert('Database not connected. Cannot export orders.');
                return;
            }
            
            try {
                const orders = await window.supabaseDB.getAllOrders();
                
                if (orders.length === 0) {
                    alert('No orders data to export.');
                    return;
                }
                
                // Create CSV headers
                const csvHeaders = [
                    'Order ID',
                    'Customer Name', 
                    'Email',
                    'Phone',
                    'Order Date',
                    'Status',
                    'Items',
                    'Total Amount',
                    'Payment Method',
                    'Address',
                    'City',
                    'State',
                    'Pincode'
                ];
                
                // Process orders data
                const csvData = orders.map(order => [
                    order.orderId || order.order_id || 'N/A',
                    ((order.firstName || order.first_name || '') + ' ' + (order.lastName || order.last_name || '')).trim() || 'Guest Customer',
                    order.email || 'N/A',
                    order.phone || 'N/A',
                    order.orderDate || order.order_date ? new Date(order.orderDate || order.order_date).toLocaleDateString('en-IN') : 'N/A',
                    (order.status || 'pending').toUpperCase(),
                    order.items ? order.items.map(item => `${item.name} (Qty: ${item.quantity})`).join('; ') : 'N/A',
                    order.total ? `${order.total.toLocaleString('en-IN')}` : '0',
                    order.payment || 'COD',
                    order.address || order.deliveryAddress || order.delivery_address || 'N/A',
                    order.city || 'N/A',
                    order.state || 'N/A',
                    order.pincode || 'N/A'
                ]);
            
            // Create CSV content
            const csvContent = [csvHeaders, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bumable-orders-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Orders data exported successfully!');
            } catch (error) {
                console.error('Error exporting orders:', error);
                alert('Failed to export orders data. Please try again.');
            }
        }
        
        // ===== CONTACT QUERIES FUNCTIONALITY =====
        
        let currentReplyQueryId = null;
        
        // Tab switching for customers section
        function showCustomerTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            // Control customer statistics visibility
            const customerStats = document.getElementById('customer-statistics');
            if (customerStats) {
                if (tabName === 'customers-list') {
                    customerStats.style.display = 'flex';
                } else {
                    customerStats.style.display = 'none';
                }
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load specific data based on tab
            if (tabName === 'contact-queries') {
                loadContactQueries();
            } else if (tabName === 'customers-list') {
                loadCustomersData();
            }
        }
        
        // Load contact queries from Supabase cloud database
        async function loadContactQueries() {
            console.log('Loading contact queries from Supabase...');
            
            try {
                let queries = [];
                
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const result = await window.supabaseDB.getAllContacts();
                    if (result.success) {
                        queries = result.contacts;
                        console.log(` Loaded ${queries.length} contact queries from Supabase`);
                    } else {
                        console.error('Failed to load contact queries:', result.error);
                    }
                } else {
                    console.log(' Supabase not ready, showing empty contact list');
                }
                
                const queriesList = document.getElementById('queries-list');
                
                if (queries.length === 0) {
                    queriesList.innerHTML = '<div class="no-orders" style="text-align: center; padding: 2rem;">No contact queries yet</div>';
                    updateNewQueriesBadge(0);
                    updateQueriesStats();
                    return;
                }
                
                // Sort queries by timestamp (newest first)
                queries.sort((a, b) => new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp));
                
                // Count new queries
                const newQueries = queries.filter(q => q.status === 'new' || q.status === 'pending').length;
                updateNewQueriesBadge(newQueries);
                
                queriesList.innerHTML = queries.map(query => createQueryCard(query)).join('');
                
                // Update contact queries statistics
                updateQueriesStats();
            } catch (error) {
                console.error('Error loading contact queries:', error);
                const queriesList = document.getElementById('queries-list');
                queriesList.innerHTML = '<div class="no-orders" style="text-align: center; padding: 2rem;">Error loading contact queries</div>';
            }
        }
        
        // Refresh customer stats (separate from loading full customer data)
        async function refreshCustomerStats() {
            if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                console.error('Database not connected');
                return;
            }
            
            try {
                const orders = await window.supabaseDB.getAllOrders();
                const customerMap = {};
                
                orders.forEach(order => {
                    const customerId = order.email || order.phone || order.orderId || order.order_id;
                    const customerName = (order.firstName || order.first_name || '') + ' ' + (order.lastName || order.last_name || '');
                    
                    if (!customerMap[customerId]) {
                        customerMap[customerId] = {
                            id: customerId,
                            name: customerName.trim() || 'Guest Customer',
                            email: order.email || 'N/A',
                            phone: order.phone || 'N/A',
                            orders: 0,
                            totalSpent: 0,
                            firstOrder: order.orderDate || order.order_date,
                            lastOrder: order.orderDate || order.order_date
                        };
                    }
                    
                    customerMap[customerId].orders++;
                    customerMap[customerId].totalSpent += parseFloat(order.total) || 0;
                    
                    const orderDate = order.orderDate || order.order_date;
                    if (new Date(orderDate) < new Date(customerMap[customerId].firstOrder)) {
                        customerMap[customerId].firstOrder = orderDate;
                    }
                    if (new Date(orderDate) > new Date(customerMap[customerId].lastOrder)) {
                        customerMap[customerId].lastOrder = orderDate;
                    }
                });
                
                const customers = Object.values(customerMap);
                updateCustomerStats(customers);
            } catch (error) {
                console.error('Error refreshing customer stats:', error);
            }
        }
        
        // Update new queries badge
        function updateNewQueriesBadge(count) {
            const badge = document.getElementById('new-queries-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Create query card HTML
        function createQueryCard(query) {
            const isNew = query.status === 'new';
            const statusIcon = isNew ? 'fas fa-envelope' : 'fas fa-check-circle';
            const statusClass = isNew ? 'status-new' : 'status-replied';
            const statusText = isNew ? 'New' : 'Replied';
            
            return `
                <div class="query-card">
                    <div class="query-header">
                        <div class="query-info">
                            <h4>${query.firstName} ${query.lastName}</h4>
                            <p>${query.email}  ${new Date(query.timestamp).toLocaleDateString('en-IN')} ${new Date(query.timestamp).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                        <div class="query-status">
                            <i class="${statusIcon} ${statusClass}"></i>
                            <span class="${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="query-body">
                        <div class="query-message">
                            "${query.message}"
                        </div>
                        ${query.adminReply ? `
                            <div class="query-reply">
                                <strong>Your Reply:</strong><br>
                                ${query.adminReply}
                                <br><small style="color: #666;">Replied on ${new Date(query.replyTimestamp).toLocaleDateString('en-IN')} ${new Date(query.replyTimestamp).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</small>
                            </div>
                        ` : ''}
                        <div class="query-actions">
                            ${!query.adminReply ? `
                                <button class="action-btn btn-primary" onclick="openReplyModal('${query.id}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            ` : `
                                <button class="action-btn btn-secondary" onclick="openReplyModal('${query.id}')">
                                    <i class="fas fa-edit"></i> Edit Reply
                                </button>
                            `}
                            <button class="action-btn btn-danger" onclick="deleteQuery('${query.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Open reply modal
        async function openReplyModal(queryId) {
            if (!window.supabaseDB || !window.supabaseDB.isReady()) {
                alert('Database not connected.');
                return;
            }
            
            try {
                const queries = await window.supabaseDB.getAllContacts();
                const query = queries.find(q => q.id === queryId);
                
                if (!query) return;
                
                currentReplyQueryId = queryId;
                
                document.getElementById('reply-customer-name').textContent = `${query.firstName || query.first_name} ${query.lastName || query.last_name}`;
                document.getElementById('reply-customer-email').textContent = query.email;
                document.getElementById('reply-original-message').textContent = query.message;
                document.getElementById('admin-reply').value = query.adminReply || query.admin_reply || '';
                
                document.getElementById('reply-modal').classList.add('show');
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error opening reply modal:', error);
                alert('Failed to load query details.');
            }
        }
        
        // Close reply modal
        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentReplyQueryId = null;
        }
        
        // Send reply
        // Send reply (deprecated - contact queries managed in Supabase)
        function sendReply() {
            alert('Contact query management is now handled through Supabase. Please use the Supabase dashboard or implement email notifications for replies.');
            closeReplyModal();
        }
        
        // Delete query (deprecated - contact queries managed in Supabase)
        function deleteQuery(queryId) {
            alert('Contact query deletion is now handled through Supabase. Please use the Supabase dashboard to manage contact queries.');
        }
        
        // ===== STATUS POPUP FUNCTIONALITY =====
        
        let currentEditingOrderId = null;
        let selectedNewStatus = null;
        
        // Open status popup
        function openStatusPopup(orderId, currentStatus) {
            console.log('Opening status popup for order:', orderId, 'with status:', currentStatus);
            
            // Ensure orderId is valid
            if (!orderId || orderId === 'undefined' || orderId === 'null') {
                alert('Error: Invalid order ID');
                return;
            }
            
            currentEditingOrderId = orderId;
            selectedNewStatus = null;
            
            // Set popup content with null check
            document.getElementById('popupOrderId').textContent = orderId;
            document.getElementById('currentStatus').textContent = (currentStatus || 'PENDING').toUpperCase();
            
            // Reset status options
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Hide selected status and save button
            document.getElementById('selectedStatus').style.display = 'none';
            document.getElementById('saveStatusBtn').style.display = 'none';
            
            // Show popup
            document.getElementById('statusPopup').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        // Close status popup
        function closeStatusPopup() {
            document.getElementById('statusPopup').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentEditingOrderId = null;
            selectedNewStatus = null;
        }
        
        // Select new status (don't save immediately)
        function selectNewStatus(newStatus) {
            selectedNewStatus = newStatus;
            
            // Update visual selection
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-status="${newStatus}"]`).classList.add('selected');
            
            // Show selected status
            document.getElementById('newStatusText').textContent = newStatus.toUpperCase();
            document.getElementById('selectedStatus').style.display = 'block';
            document.getElementById('saveStatusBtn').style.display = 'inline-block';
        }
        
        // Save order status
        async function saveOrderStatus() {
            if (!currentEditingOrderId || !selectedNewStatus) {
                alert('Please select a status first');
                return;
            }
            
            console.log('Saving order status for:', currentEditingOrderId, 'to:', selectedNewStatus);
            
            if (window.supabaseDB && window.supabaseDB.isReady()) {
                // Find the order to get its database ID
                const order = allAdminOrders.find(o => o.orderId === currentEditingOrderId);
                if (!order) {
                    alert('Order not found!');
                    return;
                }
                
                const result = await window.supabaseDB.updateOrderStatus(order.id, selectedNewStatus);
                
                if (result.success) {
                    console.log(' Order status updated successfully');
                    
                    // Close popup
                    closeStatusPopup();
                    
                    // Refresh the orders display
                    await loadAdminData();
                    
                    alert(`Order status updated to: ${selectedNewStatus.toUpperCase()}`);
                } else {
                    alert('Failed to update order status: ' + result.error);
                }
            } else {
                alert('Database not connected. Please check Supabase configuration.');
            }
        }
        
        // Helper function to get status class (keeping simple without colors)
        function getStatusClass(status) {
            return 'status-text';
        }
        
        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('statusPopup');
            if (event.target === popup) {
                closeStatusPopup();
            }
        });
        
        // Close popup with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeStatusPopup();
            }
        });
        
        // ===== DELETE FUNCTIONALITY =====
        
        // Delete order function
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                return;
            }
            
            if (window.supabaseDB && window.supabaseDB.isReady()) {
                // Find the order to get its database ID
                const order = allAdminOrders.find(o => o.orderId === orderId);
                if (!order) {
                    alert('Order not found!');
                    return;
                }
                
                const result = await window.supabaseDB.deleteOrder(order.id);
                
                if (result.success) {
                    alert('Order deleted successfully!');
                    // Refresh the orders display
                    await loadAdminData();
                } else {
                    alert('Failed to delete order: ' + result.error);
                }
            } else {
                alert('Database not connected. Please check Supabase configuration.');
            }
        }
        
        // Delete customer function
        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }
            
            if (window.supabaseDB && window.supabaseDB.isReady()) {
                const result = await window.supabaseDB.deleteUser(customerId);
                
                if (result.success) {
                    alert('Customer deleted successfully!');
                    // Refresh both displays
                    await loadAdminData();
                } else {
                    alert('Failed to delete customer: ' + result.error);
                }
            } else {
                alert('Database not connected. Please check Supabase configuration.');
            }
        }
        
        // ===== END CUSTOMER MANAGEMENT FUNCTIONS =====
        
        // Remove debug function
        // (Debug function removed as requested)
        
        // ===== END PRODUCT SYNCHRONIZATION FUNCTIONS =====

        // ===== WEBSITE LAYOUT MANAGEMENT FUNCTIONS =====
        
        // Load current layout settings from Supabase
        async function loadLayoutSettings() {
            try {
                if (window.supabase) {
                    const { data, error } = await window.supabase
                        .from('website_layout')
                        .select('*')
                        .eq('section', 'homepage')
                        .single();

                    if (!error && data && data.content) {
                        const content = JSON.parse(data.content);
                        
                        // Populate hero section
                        if (content.hero) {
                            document.getElementById('hero-title').value = content.hero.title || 'Discover BUMABLE';
                            document.getElementById('hero-subtitle').value = content.hero.subtitle || 'Mom approved. Girlfriend removed. Discover stylish men\'s underwear that owns the spotlight.';
                            document.getElementById('hero-image-1').value = content.hero.image1 || 'images/hero-product-1.jpg';
                            document.getElementById('hero-image-2').value = content.hero.image2 || 'images/hero-product-2.jpg';
                            
                            // Update previews
                            document.getElementById('hero-preview-1').src = content.hero.image1 || 'images/hero-product-1.jpg';
                            document.getElementById('hero-preview-2').src = content.hero.image2 || 'images/hero-product-2.jpg';
                        }
                        
                        // Populate Instagram section
                        if (content.instagram) {
                            document.getElementById('instagram-title').value = content.instagram.title || 'Connect on Instagram';
                            document.getElementById('instagram-subtitle').value = content.instagram.subtitle || 'Follow @bumableclothing for latest updates and style inspiration';
                            document.getElementById('instagram-profile').value = content.instagram.profile || 'https://instagram.com/bumableclothing';
                            
                            // Populate Instagram posts
                            for (let i = 1; i <= 4; i++) {
                                if (content.instagram.posts && content.instagram.posts[i-1]) {
                                    document.getElementById(`instagram-image-${i}`).value = content.instagram.posts[i-1].image || '';
                                    document.getElementById(`instagram-link-${i}`).value = content.instagram.posts[i-1].link || '';
                                    document.getElementById(`instagram-preview-${i}`).src = content.instagram.posts[i-1].image || '';
                                }
                            }
                        }
                        
                        // Populate about section
                        if (content.about) {
                            document.getElementById('about-title').value = content.about.title || 'Why Choose BUMABLE?';
                            document.getElementById('about-description').value = content.about.description || 'We believe that great underwear should be both comfortable and stylish. Our premium collection combines innovative fabrics with modern designs to give you confidence all day long.';
                        }
                        
                        console.log(' Layout settings loaded successfully');
                    }
                }
            } catch (error) {
                console.error('Error loading layout settings:', error);
            }
        }
        
        // Save layout changes to Supabase and update live site
        async function saveLayoutChanges() {
            try {
                // Show loading state
                const saveBtn = document.querySelector('button[onclick="saveLayoutChanges()"]');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
                
                // Ensure currentLayoutType is initialized
                if (typeof currentLayoutType === 'undefined' || !currentLayoutType) {
                    console.warn('currentLayoutType not initialized, using default');
                    currentLayoutType = 'featured';
                }
                
                console.log('Saving layout with type:', currentLayoutType);
                
                const layoutContent = {
                    layoutType: currentLayoutType || 'featured',
                    hero: {
                        title: document.querySelector('[data-field="hero-title"]')?.textContent || 'Mom approved\nGirlfriend removed.',
                        subtitle: document.querySelector('[data-field="hero-subtitle"]')?.textContent || 'Underwear Revolution is where comfort meets cheeky confidence, offering unique underwear for both men and women who dare to stand out. It\'s not just underwear; it\'s an attitude you wear.',
                        cta: document.querySelector('[data-field="hero-cta"]')?.textContent || 'Shop Now',
                        sale: document.querySelector('[data-field="hero-sale"]')?.textContent || 'Final Sale - Get 30% Off',
                        image1: document.getElementById('hero-img-1')?.src || '../images/hero-product-1.jpg'
                    },
                    collection: {
                        title: document.querySelector('[data-field="discover-title"]')?.textContent || 'Discover BUMABLE',
                        items: [
                            {
                                name: document.querySelector('[data-field="collection-1-name"]')?.textContent || ' Bumable Brief',
                                description: document.querySelector('[data-field="collection-1-desc"]')?.textContent || 'Cheery Red, Olive, Lt Grey, Navy, Black',
                                button: document.querySelector('[data-field="collection-1-btn"]')?.textContent || 'Shop Briefs',
                                image: document.getElementById('collection-img-1')?.src || '../images/hero-product-1.jpg'
                            },
                            {
                                name: document.querySelector('[data-field="collection-2-name"]')?.textContent || ' Tie & Dye Collection',
                                description: document.querySelector('[data-field="collection-2-desc"]')?.textContent || 'Artistic patterns & unique designs',
                                button: document.querySelector('[data-field="collection-2-btn"]')?.textContent || 'Shop Tie-Dye',
                                image: document.getElementById('collection-img-2')?.src || '../images/products/tie-dye/tie-dye-1-main.jpg'
                            },
                            {
                                name: document.querySelector('[data-field="collection-3-name"]')?.textContent || ' Solid Trunks',
                                description: document.querySelector('[data-field="collection-3-desc"]')?.textContent || 'Classic Colors & Premium Comfort',
                                button: document.querySelector('[data-field="collection-3-btn"]')?.textContent || 'Shop Trunks',
                                image: document.getElementById('collection-img-3')?.src || '../images/trunk-treasure.jpg'
                            }
                        ],
                        cta: {
                            title: document.querySelector('[data-field="collection-cta-title"]')?.textContent || 'Ready to upgrade your confidence?',
                            description: document.querySelector('[data-field="collection-cta-desc"]')?.textContent || 'Explore our complete collection and find your perfect fit',
                            button: document.querySelector('[data-field="collection-cta-btn"]')?.textContent || 'Shop Full Collection'
                        }
                    },
                    instagram: {
                        title: document.querySelector('[data-field="instagram-title"]')?.textContent || 'Connect on Instagram',
                        posts: [
                            {
                                image: document.getElementById('insta-img-1')?.src || '../images/hero-product-1.jpg',
                                alt: document.querySelector('[data-field="insta-1-alt"]')?.textContent || 'New Collections - BUMABLE',
                                link: document.getElementById('insta-link-1')?.value || 'https://instagram.com/p/example1'
                            },
                            {
                                image: document.getElementById('insta-img-2')?.src || '../images/trunk-treasure.jpg',
                                alt: document.querySelector('[data-field="insta-2-alt"]')?.textContent || 'Comfort First - BUMABLE',
                                link: document.getElementById('insta-link-2')?.value || 'https://instagram.com/p/example2'
                            },
                            {
                                image: document.getElementById('insta-img-3')?.src || '../images/hipsters.jpg',
                                alt: document.querySelector('[data-field="insta-3-alt"]')?.textContent || 'Style Guide - BUMABLE',
                                link: document.getElementById('insta-link-3')?.value || 'https://instagram.com/p/example3'
                            },
                            {
                                image: document.getElementById('insta-img-4')?.src || '../images/hero-product-2.jpg',
                                alt: document.querySelector('[data-field="insta-4-alt"]')?.textContent || 'Behind the Scenes - BUMABLE',
                                link: document.getElementById('insta-link-4')?.value || 'https://instagram.com/p/example4'
                            }
                        ]
                    },
                    about: {
                        title: document.querySelector('[data-field="about-title"]')?.textContent || 'Our Story',
                        subtitle: document.querySelector('[data-field="about-subtitle"]')?.textContent || 'Where comfort meets cheeky confidence',
                        tagline: document.querySelector('[data-field="about-tagline"]')?.textContent || 'Mom approved. Girlfriend removed.',
                        description: document.querySelector('[data-field="about-description"]')?.textContent || 'Underwear Revolution is where comfort meets cheeky confidence, offering unique underwear for both men and women who dare to stand out. It\'s not just underwear; it\'s an attitude you wear.\n\nAt BUMABLE, we believe that what you wear closest to your skin should make you feel confident, comfortable, and ready to take on the world. Our premium collection combines innovative fabric technology with bold, contemporary designs that speak to your personality.',
                        features: [
                            {
                                title: document.querySelector('[data-field="feature-1-title"]')?.textContent || 'Comfort First',
                                description: document.querySelector('[data-field="feature-1-desc"]')?.textContent || 'Premium materials for all-day comfort'
                            },
                            {
                                title: document.querySelector('[data-field="feature-2-title"]')?.textContent || 'Quality Assured',
                                description: document.querySelector('[data-field="feature-2-desc"]')?.textContent || 'Rigorous testing for durability and fit'
                            },
                            {
                                title: document.querySelector('[data-field="feature-3-title"]')?.textContent || 'Eco-Conscious',
                                description: document.querySelector('[data-field="feature-3-desc"]')?.textContent || 'Sustainable materials and processes'
                            }
                        ],
                        image: document.getElementById('about-img-1')?.src || '../images/hero-product-2.jpg'
                    },
                    footer: {
                        contact: {
                            title: document.querySelector('[data-field="footer-contact-title"]')?.textContent || 'Get in Touch',
                            address: document.querySelector('[data-field="footer-address"]')?.textContent || 'Palavanchipalayam\nTiruppur, Tamilnadu\n641605',
                            email: document.querySelector('[data-field="footer-email"]')?.textContent || 'ingeniumcouture@gmail.com'
                        },
                        quickLinks: {
                            title: document.querySelector('[data-field="footer-links-title"]')?.textContent || 'Quick Links',
                            links: [
                                document.querySelector('[data-field="footer-link-1"]')?.textContent || 'Home',
                                document.querySelector('[data-field="footer-link-2"]')?.textContent || 'Shop',
                                document.querySelector('[data-field="footer-link-3"]')?.textContent || 'Our Story',
                                document.querySelector('[data-field="footer-link-4"]')?.textContent || 'Contact Us'
                            ]
                        },
                        policies: {
                            title: document.querySelector('[data-field="footer-policies-title"]')?.textContent || 'Policies',
                            links: [
                                document.querySelector('[data-field="footer-policy-1"]')?.textContent || 'Store Policy',
                                document.querySelector('[data-field="footer-policy-2"]')?.textContent || 'Shipping & Returns',
                                document.querySelector('[data-field="footer-policy-3"]')?.textContent || 'FAQ'
                            ]
                        },
                        social: {
                            title: document.querySelector('[data-field="footer-social-title"]')?.textContent || 'Follow Us',
                            facebook: document.querySelector('[data-field="footer-facebook"]')?.textContent || 'https://www.facebook.com/profile.php?id=61560298989888',
                            instagram: document.querySelector('[data-field="footer-instagram"]')?.textContent || 'https://www.instagram.com/bumableclothing/',
                            pinterest: document.querySelector('[data-field="footer-pinterest"]')?.textContent || 'https://in.pinterest.com/bumableclothing/'
                        },
                        copyright: document.querySelector('[data-field="footer-copyright"]')?.textContent || ' 2025 by BUMABLE. All rights reserved.'
                    }
                };
                
                // Save to Supabase for cross-device synchronization
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const { error } = await window.supabaseDB.client
                        .from('website_layout')
                        .upsert({
                            section: 'homepage',
                            content: JSON.stringify(layoutContent),
                            updated_at: new Date().toISOString(),
                            updated_by: 'admin'
                        });

                    if (error) {
                        console.error('Error saving layout:', error);
                        throw new Error('Database save failed: ' + error.message);
                    }
                    
                    console.log(' Layout changes saved to Supabase');
                } else {
                    console.warn('Supabase not available, saving to localStorage only');
                }
                
                // Trigger real-time update to main website files
                await updateMainWebsiteFiles(layoutContent);
                
                // Success notification
                showNotification('Layout changes saved successfully! Changes are live across all devices.', 'success');
                
                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                return layoutContent;
                
            } catch (error) {
                console.error('Error saving layout changes:', error);
                
                // Restore button state
                const saveBtn = document.querySelector('button[onclick="saveLayoutChanges()"]');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    saveBtn.disabled = false;
                }
                
                showNotification('Error saving layout changes: ' + error.message, 'error');
                throw error;
            }
        }
        
        // Update main website files with new content
        async function updateMainWebsiteFiles(layoutContent) {
            try {
                // This function would update the actual main website files
                // For now, we'll update a JSON file that the main site can read
                
                const updateData = {
                    ...layoutContent,
                    lastUpdated: new Date().toISOString(),
                    version: Date.now()
                };
                
                // In a real implementation, this would:
                // 1. Update static HTML files
                // 2. Regenerate CSS/JS with new content
                // 3. Clear CDN cache
                // 4. Notify other connected users
                
                console.log(' Main website files updated');
                
                // Broadcast update to other tabs/devices
                if ('BroadcastChannel' in window) {
                    const channel = new BroadcastChannel('bumable-admin-updates');
                    channel.postMessage({
                        type: 'layout-updated',
                        data: updateData,
                        timestamp: Date.now()
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Error updating main website files:', error);
                return false;
            }
        }
        
        // Upload hero image
        function uploadHeroImage(imageNumber) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // In a real implementation, you would upload to a cloud storage service
                    // For now, we'll use a placeholder URL
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        document.getElementById(`hero-image-${imageNumber}`).value = imageUrl;
                        document.getElementById(`hero-preview-${imageNumber}`).src = imageUrl;
                        
                        alert(`Hero image ${imageNumber} uploaded! Remember to save changes.`);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // Upload Instagram image
        function uploadInstagramImage(postNumber) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        document.getElementById(`instagram-image-${postNumber}`).value = imageUrl;
                        document.getElementById(`instagram-preview-${postNumber}`).src = imageUrl;
                        
                        alert(`Instagram post ${postNumber} image uploaded! Remember to save changes.`);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // Save current changes as draft (manual save for current work)
        async function resetLayoutToDefault() {
            if (confirm('Save your current changes as a draft? This will preserve your work without deploying it live.')) {
                try {
                    showDeploymentStatus('Saving current changes as draft...', 'deploying');
                    
                    // Gather current layout data from the editor
                    const layoutContent = gatherCurrentLayoutData();
                    const draftVersion = {
                        id: `draft_${Date.now()}`,
                        content: layoutContent,
                        type: 'draft',
                        created_at: new Date().toISOString(),
                        created_by: 'admin',
                        description: 'Manual draft save - current changes',
                        changes: calculateChanges(layoutContent, lastDeployedVersion?.content || {})
                    };
                    
                    // Save to Supabase
                    if (window.supabase) {
                        const { error } = await window.supabase
                            .from('website_deployments')
                            .upsert(draftVersion);
                        
                        if (error) throw error;
                    }
                    
                    // Save in session (not persistent across browser restarts)
                    sessionStorage.setItem('bumable_current_draft', JSON.stringify(draftVersion));
                    currentDraft = draftVersion;
                    
                    showDeploymentStatus('Current changes saved as draft', 'draft');
                    showNotification(' Current changes saved as draft! You can deploy when ready.', 'success');
                    
                    // Update deployment status to reflect the new draft
                    updateDeploymentStatus();
                    
                } catch (error) {
                    console.error('Error saving current changes as draft:', error);
                    showDeploymentStatus('Error saving draft', 'error');
                    showNotification('Error saving draft: ' + error.message, 'error');
                }
            }
        }
        
        // Update all image previews
        function updateAllPreviews() {
            document.getElementById('hero-preview-1').src = document.getElementById('hero-image-1').value;
            document.getElementById('hero-preview-2').src = document.getElementById('hero-image-2').value;
            
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`instagram-preview-${i}`).src = document.getElementById(`instagram-image-${i}`).value;
            }
        }
        
        // Open homepage preview in new tab
        function openHomepagePreview() {
            window.open('../', '_blank');
        }
        
        // Publish changes (same as save for now)
        function publishChanges() {
            if (confirm('Are you sure you want to publish these changes to the live website?')) {
                saveLayoutChanges();
            }
        }
        
        // Update homepage content dynamically
        async function updateHomepageContent() {
            try {
                // This would typically trigger a webhook or API call to update the live site
                console.log(' Triggering homepage content update...');
                
                // In a real implementation, you might call an API to regenerate static files
                // or update content in a CMS
                
                return true;
            } catch (error) {
                console.error('Error updating homepage content:', error);
                return false;
            }
        }
        
        // Add event listeners for real-time preview updates
        document.addEventListener('DOMContentLoaded', function() {
            // Load layout settings when website-layout section is shown
            const originalShowSection = showSection;
            showSection = function(sectionName) {
                originalShowSection(sectionName);
                if (sectionName === 'website-layout') {
                    loadLayoutSettings();
                }
            };
            
            // Add event listeners for image URL changes
            setTimeout(() => {
                const imageInputs = [
                    'hero-image-1', 'hero-image-2',
                    'instagram-image-1', 'instagram-image-2', 'instagram-image-3', 'instagram-image-4'
                ];
                
                imageInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', function() {
                            const previewId = inputId.replace('image', 'preview');
                            const preview = document.getElementById(previewId);
                            if (preview) {
                                preview.src = this.value;
                            }
                        });
                    }
                });
            }, 1000);
        });
        
        // ===== END WEBSITE LAYOUT MANAGEMENT FUNCTIONS =====
        
        // ===== VISUAL LAYOUT EDITOR FUNCTIONS =====
        // Layout Type Selection - Simplified and Fixed
        function selectLayoutType(layoutType) {
            console.log('Layout type clicked:', layoutType);
            
            // Update current layout type
            currentLayoutType = layoutType;
            
            // Remove active class from all layout types
            const allLayoutTypes = document.querySelectorAll('.layout-type');
            allLayoutTypes.forEach(type => {
                type.classList.remove('active');
            });
            
            // Add active class to selected layout type
            const selectedLayout = document.querySelector(`[data-layout="${layoutType}"]`);
            if (selectedLayout) {
                selectedLayout.classList.add('active');
                console.log('Layout activated:', layoutType);
            }
        // ===== DEPLOYMENT SYSTEM =====
        
        let currentDraft = null;
        let deploymentHistory = [];
        let lastDeployedVersion = null;
        
        // Initialize deployment system
        async function initializeDeploymentSystem() {
            await loadDeploymentHistory();
            await loadCurrentDraft();
            updateDeploymentStatus();
        }
        
        // Save as draft (doesn't deploy)
        async function saveAsDraft() {
            try {
                showDeploymentStatus('Saving draft...', 'deploying');
                
                const layoutContent = gatherCurrentLayoutData();
                const draftVersion = {
                    id: `draft_${Date.now()}`,
                    content: layoutContent,
                    type: 'draft',
                    created_at: new Date().toISOString(),
                    created_by: 'admin',
                    description: 'Auto-saved draft',
                    changes: calculateChanges(layoutContent, lastDeployedVersion?.content || {})
                };
                
                // Save to Supabase
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('website_deployments')
                        .upsert(draftVersion);
                    
                    if (error) throw error;
                }
                
                // Save in session (not persistent across browser restarts)
                sessionStorage.setItem('bumable_current_draft', JSON.stringify(draftVersion));
                currentDraft = draftVersion;
                
                showDeploymentStatus('Draft saved successfully', 'draft');
                showNotification('Draft saved! Ready to deploy when you\'re ready.', 'success');
                
            } catch (error) {
                console.error('Error saving draft:', error);
                showDeploymentStatus('Error saving draft', 'error');
                showNotification('Error saving draft: ' + error.message, 'error');
            }
        }
        
        // Deploy to live website
        async function deployChanges() {
            if (!currentDraft) {
                await saveAsDraft();
            }
            
            // Show confirmation modal
            showDeployConfirmation();
        }
        
        // Show deployment confirmation modal
        function showDeployConfirmation() {
            const modal = document.getElementById('deploy-confirmation-modal');
            const changesList = document.getElementById('deploy-changes-list');
            
            if (currentDraft && currentDraft.changes) {
                changesList.innerHTML = '';
                currentDraft.changes.forEach(change => {
                    const li = document.createElement('li');
                    li.textContent = change;
                    changesList.appendChild(li);
                });
            }
            
            modal.classList.add('show');
        }
        
        // Close deployment confirmation
        function closeDeployConfirmation() {
            document.getElementById('deploy-confirmation-modal').classList.remove('show');
        }
        
        // Confirm and execute deployment
        async function confirmDeployment() {
            try {
                closeDeployConfirmation();
                showDeploymentStatus('Deploying to live website...', 'deploying');
                
                const description = document.getElementById('deploy-description').value.trim() || 'Website layout update';
                
                const deployment = {
                    id: `deploy_${Date.now()}`,
                    content: currentDraft.content,
                    type: 'deployment',
                    status: 'deployed',
                    created_at: new Date().toISOString(),
                    created_by: 'admin',
                    description: description,
                    changes: currentDraft.changes || [],
                    version: getNextVersionNumber()
                };
                
                // Save deployment to Supabase
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('website_deployments')
                        .insert(deployment);
                    
                    if (error) throw error;
                    
                    // Update live website content
                    const { error: updateError } = await window.supabase
                        .from('website_layout')
                        .upsert({
                            section: 'homepage',
                            content: JSON.stringify(deployment.content),
                            updated_at: deployment.created_at,
                            updated_by: 'admin',
                            deployment_id: deployment.id
                        });
                    
                    if (updateError) throw updateError;
                }
                
                // Update local state
                lastDeployedVersion = deployment;
                deploymentHistory.unshift(deployment);
                
                // Clear current draft
                currentDraft = null;
                sessionStorage.removeItem('bumable_current_draft');
                
                // Broadcast to other devices
                if ('BroadcastChannel' in window) {
                    const channel = new BroadcastChannel('bumable-admin-updates');
                    channel.postMessage({
                        type: 'deployment-completed',
                        deployment: deployment,
                        timestamp: Date.now()
                    });
                }
                
                showDeploymentStatus(`Successfully deployed v${deployment.version}`, 'deployed');
                showNotification(` Saved to database! Version ${deployment.version}`, 'success');
                
                // Trigger Vercel deployment for live site update
                if (window.VercelDeploy && window.VercelDeploy.trigger) {
                    showNotification(' Triggering live site deployment...', 'info');
                    const deployResult = await window.VercelDeploy.trigger(description);
                    
                    if (deployResult.success) {
                        showNotification(` ${deployResult.message}`, 'success', 5000);
                    } else {
                        showNotification(` Database updated but auto-deployment failed. Please deploy manually from Vercel dashboard.`, 'warning', 7000);
                    }
                } else {
                    showNotification(' Changes saved to database. Vercel deploy hook not configured. Changes may take a few minutes to appear or require manual deployment.', 'warning', 7000);
                }
                
                // Clear deployment description
                document.getElementById('deploy-description').value = '';
                
            } catch (error) {
                console.error('Deployment error:', error);
                showDeploymentStatus('Deployment failed', 'error');
                showNotification('Deployment failed: ' + error.message, 'error');
            }
        }
        
        // Rollback to a previous version
        async function rollbackToVersion(deploymentId) {
            try {
                const deployment = deploymentHistory.find(d => d.id === deploymentId);
                if (!deployment) {
                    throw new Error('Deployment not found');
                }
                
                if (!confirm(`Are you sure you want to rollback to "${deployment.description}" (v${deployment.version})?\n\nThis will immediately update the live website.`)) {
                    return;
                }
                
                showDeploymentStatus(`Rolling back to v${deployment.version}...`, 'deploying');
                
                // Create rollback deployment
                const rollbackDeployment = {
                    id: `rollback_${Date.now()}`,
                    content: deployment.content,
                    type: 'rollback',
                    status: 'deployed',
                    created_at: new Date().toISOString(),
                    created_by: 'admin',
                    description: `Rollback to v${deployment.version}: ${deployment.description}`,
                    changes: [`Rolled back to version ${deployment.version}`],
                    version: getNextVersionNumber(),
                    rollback_from: deploymentId
                };
                
                // Save to Supabase
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('website_deployments')
                        .insert(rollbackDeployment);
                    
                    if (error) throw error;
                    
                    // Update live content
                    const { error: updateError } = await window.supabase
                        .from('website_layout')
                        .upsert({
                            section: 'homepage',
                            content: JSON.stringify(rollbackDeployment.content),
                            updated_at: rollbackDeployment.created_at,
                            updated_by: 'admin',
                            deployment_id: rollbackDeployment.id
                        });
                    
                    if (updateError) throw updateError;
                }
                
                // Update local state
                lastDeployedVersion = rollbackDeployment;
                deploymentHistory.unshift(rollbackDeployment);
                
                // Apply changes to editor
                applyLayoutDataToEditor(rollbackDeployment.content);
                
                // Broadcast update
                if ('BroadcastChannel' in window) {
                    const channel = new BroadcastChannel('bumable-admin-updates');
                    channel.postMessage({
                        type: 'rollback-completed',
                        deployment: rollbackDeployment,
                        timestamp: Date.now()
                    });
                }
                
                showDeploymentStatus(`Rolled back to v${rollbackDeployment.version}`, 'deployed');
                showNotification(` Successfully rolled back to v${deployment.version}`, 'success');
                
                // Refresh deployment history
                loadDeploymentHistory();
                
            } catch (error) {
                console.error('Rollback error:', error);
                showNotification('Rollback failed: ' + error.message, 'error');
            }
        }
        
        // Show deployment history modal
        async function showDeploymentHistory() {
            await loadDeploymentHistory();
            renderDeploymentHistory();
            document.getElementById('deployment-modal').classList.add('show');
        }
        
        // Close deployment history modal
        function closeDeploymentHistory() {
            document.getElementById('deployment-modal').classList.remove('show');
        }
        
        // Load deployment history from Supabase
        async function loadDeploymentHistory() {
            try {
                if (window.supabase) {
                    const { data, error } = await window.supabase
                        .from('website_deployments')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    if (error) throw error;
                    
                    deploymentHistory = data || [];
                    
                    // Find last deployed version
                    lastDeployedVersion = deploymentHistory.find(d => 
                        d.type === 'deployment' || d.type === 'rollback'
                    ) || null;
                }
            } catch (error) {
                console.error('Error loading deployment history:', error);
            }
        }
        
        // Load current draft
        async function loadCurrentDraft() {
            try {
                // Try to load from Supabase first
                if (window.supabase) {
                    const { data, error } = await window.supabase
                        .from('website_deployments')
                        .select('*')
                        .eq('type', 'draft')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (!error && data && data.length > 0) {
                        currentDraft = data[0];
                        return;
                    }
                }
                
                // Check sessionStorage (temporary, same session only)
                const sessionDraft = sessionStorage.getItem('bumable_current_draft');
                if (sessionDraft) {
                    currentDraft = JSON.parse(sessionDraft);
                }
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }
        
        // Render deployment history
        function renderDeploymentHistory() {
            const container = document.getElementById('deployment-list');
            container.innerHTML = '';
            
            if (deploymentHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No deployments yet</p>';
                return;
            }
            
            deploymentHistory.forEach((deployment, index) => {
                const isLive = index === 0 && (deployment.type === 'deployment' || deployment.type === 'rollback');
                
                const item = document.createElement('div');
                item.className = `deployment-item ${isLive ? 'current' : ''}`;
                
                const statusBadge = getStatusBadge(deployment);
                const timeAgo = getTimeAgo(deployment.created_at);
                
                item.innerHTML = `
                    <div class="deployment-header">
                        <div class="deployment-info">
                            <h4>${deployment.description}</h4>
                            <div class="deployment-meta">
                                Version ${deployment.version || 'N/A'}  ${timeAgo}  ${deployment.created_by}
                                ${deployment.type === 'rollback' ? '  <span style="color: #e17055;">Rollback</span>' : ''}
                            </div>
                        </div>
                        <div class="deployment-actions">
                            ${statusBadge}
                            ${!isLive && (deployment.type === 'deployment' || deployment.type === 'rollback') ? 
                                `<button class="action-btn btn-warning" onclick="rollbackToVersion('${deployment.id}')">
                                    <i class="fas fa-undo"></i> Rollback
                                </button>` : ''
                            }
                        </div>
                    </div>
                    
                    ${deployment.changes && deployment.changes.length > 0 ? `
                        <div class="deployment-changes">
                            <h5>Changes:</h5>
                            <ul class="changes-list">
                                ${deployment.changes.map(change => `<li>${change}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(item);
            });
        }
        
        // Helper functions
        function getStatusBadge(deployment) {
            const statusMap = {
                'deployed': { class: 'status-deployed', text: 'Deployed', icon: 'check-circle' },
                'rollback': { class: 'status-deployed', text: 'Rolled Back', icon: 'undo' },
                'draft': { class: 'status-draft', text: 'Draft', icon: 'edit' },
                'deploying': { class: 'status-deploying', text: 'Deploying', icon: 'spinner' },
                'failed': { class: 'status-failed', text: 'Failed', icon: 'exclamation-triangle' }
            };
            
            const status = statusMap[deployment.status] || statusMap[deployment.type] || statusMap.draft;
            
            return `<span class="deployment-status-badge ${status.class}">
                <i class="fas fa-${status.icon}"></i> ${status.text}
            </span>`;
        }
        
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return `${diff} seconds ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            
            return date.toLocaleDateString();
        }
        
        function getNextVersionNumber() {
            if (deploymentHistory.length === 0) return 1;
            
            const lastVersion = deploymentHistory
                .filter(d => d.version)
                .map(d => d.version)
                .sort((a, b) => b - a)[0] || 0;
            
            return lastVersion + 1;
        }
        
        function calculateChanges(newContent, oldContent) {
            const changes = [];
            
            // Compare hero section
            if (JSON.stringify(newContent.hero) !== JSON.stringify(oldContent.hero)) {
                changes.push('Hero section updated');
            }
            
            // Compare collection section
            if (JSON.stringify(newContent.collection) !== JSON.stringify(oldContent.collection)) {
                changes.push('Product collection updated');
            }
            
            // Compare Instagram section
            if (JSON.stringify(newContent.instagram) !== JSON.stringify(oldContent.instagram)) {
                changes.push('Instagram section updated');
            }
            
            // Compare about section
            if (JSON.stringify(newContent.about) !== JSON.stringify(oldContent.about)) {
                changes.push('About section updated');
            }
            
            // Compare footer
            if (JSON.stringify(newContent.footer) !== JSON.stringify(oldContent.footer)) {
                changes.push('Footer updated');
            }
            
            return changes.length > 0 ? changes : ['Content updated'];
        }
        
        function showDeploymentStatus(message, type) {
            const statusBar = document.getElementById('deployment-status');
            const messageEl = document.getElementById('deployment-message');
            const lastDeployEl = document.getElementById('last-deployment');
            
            messageEl.textContent = message;
            statusBar.className = `deployment-status ${type}`;
            statusBar.style.display = 'flex';
            
            // Update last deployment info
            if (lastDeployedVersion) {
                const timeAgo = getTimeAgo(lastDeployedVersion.created_at);
                lastDeployEl.textContent = `Last deployed: v${lastDeployedVersion.version}  ${timeAgo}`;
            }
            
            // Auto-hide after delay for non-permanent states
            if (type === 'deploying') {
                setTimeout(() => updateDeploymentStatus(), 5000);
            }
        }
        
        function updateDeploymentStatus() {
            if (currentDraft) {
                showDeploymentStatus('You have unsaved changes ready to deploy', 'draft');
            } else if (lastDeployedVersion) {
                showDeploymentStatus('Your website is up to date', 'deployed');
            } else {
                showDeploymentStatus('Ready to deploy your first version', 'draft');
            }
        }
        
        // Enhanced preview function with draft support
        function previewLayout() {
            console.log('Preview button clicked');
            
            // Show loading state
            const previewBtn = document.querySelector('button[onclick="previewLayout()"]');
            const originalText = previewBtn.innerHTML;
            previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Preview...';
            previewBtn.disabled = true;
            
            // Save current changes as draft first
            saveAsDraft().then(() => {
                // Create preview with current changes
                const currentLayoutData = gatherCurrentLayoutData();
                
                // Save preview data temporarily
                sessionStorage.setItem('bumable_preview_data', JSON.stringify({
                    ...currentLayoutData,
                    isPreview: true,
                    previewTimestamp: Date.now()
                }));
                
                // Open preview in new tab
                const previewUrl = `../index.html?preview=true&timestamp=${Date.now()}`;
                window.open(previewUrl, '_blank');
                
                showNotification('Preview opened! Changes saved as draft.', 'info');
                
            }).catch(error => {
                console.error('Error saving draft for preview:', error);
                showNotification('Error preparing preview: ' + error.message, 'error');
            }).finally(() => {
                // Restore button state
                setTimeout(() => {
                    previewBtn.innerHTML = originalText;
                    previewBtn.disabled = false;
                }, 1500);
            });
        }
        
        // ===== END DEPLOYMENT SYSTEM =====
        
        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.admin-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `admin-notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add styles if not already present
            if (!document.getElementById('notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'notification-styles';
                styles.textContent = `
                    .admin-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        padding: 1rem 1.5rem;
                        max-width: 400px;
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        border-left: 4px solid #007bff;
                        animation: slideInRight 0.3s ease-out;
                    }
                    .notification-success { border-left-color: #28a745; }
                    .notification-error { border-left-color: #dc3545; }
                    .notification-warning { border-left-color: #ffc107; }
                    .notification-info { border-left-color: #17a2b8; }
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    }
                    .notification-content i {
                        color: #666;
                    }
                    .notification-success .notification-content i { color: #28a745; }
                    .notification-error .notification-content i { color: #dc3545; }
                    .notification-warning .notification-content i { color: #ffc107; }
                    .notification-info .notification-content i { color: #17a2b8; }
                    .notification-close {
                        background: none;
                        border: none;
                        color: #999;
                        cursor: pointer;
                        padding: 0;
                        margin-left: 1rem;
                    }
                    .notification-close:hover { color: #666; }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        // Listen for updates from other tabs/devices
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('bumable-admin-updates');
            channel.addEventListener('message', function(event) {
                if (event.data.type === 'layout-updated') {
                    showNotification('Layout updated from another device/tab. Refresh to see changes.', 'info');
                }
            });
        }
        
        // Auto-save functionality (optional)
        let autoSaveTimeout;
        function enableAutoSave() {
            // Listen for changes in editable elements
            document.addEventListener('input', function(event) {
                if (event.target.hasAttribute('contenteditable') && event.target.hasAttribute('data-field')) {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        console.log('Auto-saving changes...');
                        saveLayoutChanges().catch(error => {
                            console.log('Auto-save failed:', error.message);
                        });
                    }, 10000); // Auto-save after 10 seconds of inactivity
                }
            });
        }
        
        // Initialize enhanced features when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Enhanced admin panel loaded');
            
            // Enable auto-save (optional - uncomment if desired)
            // enableAutoSave();
            
            // Load any existing layout data
            loadExistingLayoutData();
        });
        
        // Load existing layout data from storage
        async function loadExistingLayoutData() {
            try {
                // Load from Supabase (primary source)
                if (window.supabaseDB && window.supabaseDB.isReady()) {
                    const { data, error } = await window.supabaseDB.client
                        .from('website_layout')
                        .select('content')
                        .eq('section', 'homepage')
                        .single();
                    
                    if (!error && data) {
                        const layoutContent = JSON.parse(data.content);
                        applyLayoutDataToEditor(layoutContent);
                        console.log(' Layout data loaded from Supabase');
                        return;
                    }
                }
                
                // If no data in Supabase, editor will show default placeholders
                console.log(' No layout data found in Supabase - using editor defaults');
                
            } catch (error) {
                console.error('Error loading layout data:', error);
            }
        }
        
        // Apply loaded data to the editor interface
        function applyLayoutDataToEditor(layoutContent) {
            if (!layoutContent) return;
            
            try {
                // Apply hero section data
                if (layoutContent.hero) {
                    const heroTitle = document.querySelector('[data-field="hero-title"]');
                    const heroSubtitle = document.querySelector('[data-field="hero-subtitle"]');
                    const heroCta = document.querySelector('[data-field="hero-cta"]');
                    const heroSale = document.querySelector('[data-field="hero-sale"]');
                    const heroImg = document.getElementById('hero-img-1');
                    
                    if (heroTitle) heroTitle.textContent = layoutContent.hero.title;
                    if (heroSubtitle) heroSubtitle.textContent = layoutContent.hero.subtitle;
                    if (heroCta) heroCta.textContent = layoutContent.hero.cta;
                    if (heroSale) heroSale.textContent = layoutContent.hero.sale;
                    if (heroImg) heroImg.src = layoutContent.hero.image1;
                }
                
                // Apply collection section data
                if (layoutContent.collection) {
                    const discoverTitle = document.querySelector('[data-field="discover-title"]');
                    if (discoverTitle) discoverTitle.textContent = layoutContent.collection.title;
                    
                    // Apply collection items
                    layoutContent.collection.items.forEach((item, index) => {
                        const itemIndex = index + 1;
                        const nameEl = document.querySelector(`[data-field="collection-${itemIndex}-name"]`);
                        const descEl = document.querySelector(`[data-field="collection-${itemIndex}-desc"]`);
                        const btnEl = document.querySelector(`[data-field="collection-${itemIndex}-btn"]`);
                        const imgEl = document.getElementById(`collection-img-${itemIndex}`);
                        
                        if (nameEl) nameEl.textContent = item.name;
                        if (descEl) descEl.textContent = item.description;
                        if (btnEl) btnEl.textContent = item.button;
                        if (imgEl) imgEl.src = item.image;
                    });
                }
                
                // Apply Instagram section data
                if (layoutContent.instagram) {
                    const instaTitle = document.querySelector('[data-field="instagram-title"]');
                    if (instaTitle) instaTitle.textContent = layoutContent.instagram.title;
                    
                    layoutContent.instagram.posts.forEach((post, index) => {
                        const postIndex = index + 1;
                        const imgEl = document.getElementById(`insta-img-${postIndex}`);
                        const altEl = document.querySelector(`[data-field="insta-${postIndex}-alt"]`);
                        const linkEl = document.getElementById(`insta-link-${postIndex}`);
                        
                        if (imgEl) imgEl.src = post.image;
                        if (altEl) altEl.textContent = post.alt;
                        if (linkEl) linkEl.value = post.link;
                    });
                }
                
                // Apply about section data
                if (layoutContent.about) {
                    const aboutTitle = document.querySelector('[data-field="about-title"]');
                    const aboutSubtitle = document.querySelector('[data-field="about-subtitle"]');
                    const aboutTagline = document.querySelector('[data-field="about-tagline"]');
                    const aboutDescription = document.querySelector('[data-field="about-description"]');
                    
                    if (aboutTitle) aboutTitle.textContent = layoutContent.about.title;
                    if (aboutSubtitle) aboutSubtitle.textContent = layoutContent.about.subtitle;
                    if (aboutTagline) aboutTagline.textContent = layoutContent.about.tagline;
                    if (aboutDescription) aboutDescription.textContent = layoutContent.about.description;
                }
                
                console.log(' Layout data applied to editor');
                
            } catch (error) {
                console.error('Error applying layout data to editor:', error);
            }
        }

        // Enhanced Preview Function with real-time updates
        function previewLayout() {
            console.log('Preview button clicked');
            
            // Show loading state
            const previewBtn = document.querySelector('button[onclick="previewLayout()"]');
            const originalText = previewBtn.innerHTML;
            previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Preview...';
            previewBtn.disabled = true;
            
            // Create preview with current changes (without saving permanently)
            const currentLayoutData = gatherCurrentLayoutData();
            
            // Save preview data temporarily
            sessionStorage.setItem('bumable_preview_data', JSON.stringify(currentLayoutData));
            
            // Open preview in new tab with timestamp to force refresh
            const previewUrl = `../index.html?preview=true&timestamp=${Date.now()}`;
            const previewWindow = window.open(previewUrl, '_blank');
            
            // Restore button state after a delay
            setTimeout(() => {
                previewBtn.innerHTML = originalText;
                previewBtn.disabled = false;
            }, 2000);
            
            // Optional: Save changes before preview if user wants
            setTimeout(() => {
                if (confirm('Would you like to save these changes permanently before previewing?')) {
                    saveLayoutChanges().then(() => {
                        showNotification('Changes saved! Preview shows live version.', 'success');
                    }).catch(error => {
                        showNotification('Error saving changes: ' + error.message, 'error');
                    });
                } else {
                    showNotification('Showing preview with unsaved changes. Save to make them permanent.', 'info');
                }
            }, 500);
        }
        
        // Gather current layout data from editor
        function gatherCurrentLayoutData() {
            return {
                layoutType: currentLayoutType || 'featured',
                hero: {
                    title: document.querySelector('[data-field="hero-title"]')?.textContent || 'Mom approved\nGirlfriend removed.',
                    subtitle: document.querySelector('[data-field="hero-subtitle"]')?.textContent || 'Underwear Revolution...',
                    cta: document.querySelector('[data-field="hero-cta"]')?.textContent || 'Shop Now',
                    sale: document.querySelector('[data-field="hero-sale"]')?.textContent || 'Final Sale - Get 30% Off',
                    image1: document.getElementById('hero-img-1')?.src || '../images/hero-product-1.jpg'
                },
                collection: {
                    title: document.querySelector('[data-field="discover-title"]')?.textContent || 'Discover BUMABLE',
                    items: [
                        {
                            name: document.querySelector('[data-field="collection-1-name"]')?.textContent || ' Bumable Brief',
                            description: document.querySelector('[data-field="collection-1-desc"]')?.textContent || 'Cheery Red, Olive, Lt Grey, Navy, Black',
                            button: document.querySelector('[data-field="collection-1-btn"]')?.textContent || 'Shop Briefs',
                            image: document.getElementById('collection-img-1')?.src || '../images/hero-product-1.jpg'
                        },
                        {
                            name: document.querySelector('[data-field="collection-2-name"]')?.textContent || ' Tie & Dye Collection',
                            description: document.querySelector('[data-field="collection-2-desc"]')?.textContent || 'Artistic patterns & unique designs',
                            button: document.querySelector('[data-field="collection-2-btn"]')?.textContent || 'Shop Tie-Dye',
                            image: document.getElementById('collection-img-2')?.src || '../images/products/tie-dye/tie-dye-1-main.jpg'
                        },
                        {
                            name: document.querySelector('[data-field="collection-3-name"]')?.textContent || ' Solid Trunks',
                            description: document.querySelector('[data-field="collection-3-desc"]')?.textContent || 'Classic Colors & Premium Comfort',
                            button: document.querySelector('[data-field="collection-3-btn"]')?.textContent || 'Shop Trunks',
                            image: document.getElementById('collection-img-3')?.src || '../images/trunk-treasure.jpg'
                        }
                    ],
                    cta: {
                        title: document.querySelector('[data-field="collection-cta-title"]')?.textContent || 'Ready to upgrade your confidence?',
                        description: document.querySelector('[data-field="collection-cta-desc"]')?.textContent || 'Explore our complete collection and find your perfect fit',
                        button: document.querySelector('[data-field="collection-cta-btn"]')?.textContent || 'Shop Full Collection'
                    }
                },
                instagram: {
                    title: document.querySelector('[data-field="instagram-title"]')?.textContent || 'Connect on Instagram',
                    posts: [
                        {
                            image: document.getElementById('insta-img-1')?.src || '../images/hero-product-1.jpg',
                            alt: document.querySelector('[data-field="insta-1-alt"]')?.textContent || 'New Collections - BUMABLE',
                            link: document.getElementById('insta-link-1')?.value || 'https://instagram.com/p/example1'
                        },
                        {
                            image: document.getElementById('insta-img-2')?.src || '../images/trunk-treasure.jpg',
                            alt: document.querySelector('[data-field="insta-2-alt"]')?.textContent || 'Comfort First - BUMABLE',
                            link: document.getElementById('insta-link-2')?.value || 'https://instagram.com/p/example2'
                        },
                        {
                            image: document.getElementById('insta-img-3')?.src || '../images/hipsters.jpg',
                            alt: document.querySelector('[data-field="insta-3-alt"]')?.textContent || 'Style Guide - BUMABLE',
                            link: document.getElementById('insta-link-3')?.value || 'https://instagram.com/p/example3'
                        },
                        {
                            image: document.getElementById('insta-img-4')?.src || '../images/hero-product-2.jpg',
                            alt: document.querySelector('[data-field="insta-4-alt"]')?.textContent || 'Behind the Scenes - BUMABLE',
                            link: document.getElementById('insta-link-4')?.value || 'https://instagram.com/p/example4'
                        }
                    ]
                },
                about: {
                    title: document.querySelector('[data-field="about-title"]')?.textContent || 'Our Story',
                    subtitle: document.querySelector('[data-field="about-subtitle"]')?.textContent || 'Where comfort meets cheeky confidence',
                    tagline: document.querySelector('[data-field="about-tagline"]')?.textContent || 'Mom approved. Girlfriend removed.',
                    description: document.querySelector('[data-field="about-description"]')?.textContent || 'Underwear Revolution is where comfort meets cheeky confidence...'
                },
                lastUpdated: new Date().toISOString(),
                isPreview: true
            };
        }

        // Section Toggle Functions
        function toggleSection(sectionName) {
            const section = document.querySelector(`.${sectionName}-editor .visual-layout-container`);
            const toggleButton = document.querySelector(`.${sectionName}-editor .toggle-section i`);
            
            if (section && section.style.display === 'none') {
                section.style.display = 'block';
                if (toggleButton) toggleButton.className = 'fas fa-chevron-up';
            } else if (section) {
                section.style.display = 'none';
                if (toggleButton) toggleButton.className = 'fas fa-chevron-down';
            }
        }

        // Image Management Functions
        function selectImageSlot(slotId) {
            document.querySelectorAll('.image-slot, .instagram-post').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            const slot = document.querySelector(`[onclick*="${slotId}"]`);
            if (slot) {
                slot.classList.add('selected');
            }
        }

        function uploadImage(slotId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    handleImageUpload(file, slotId);
                }
            };
            input.click();
        }

        function handleImageUpload(file, slotId) {
            console.log('Handling image upload for slot:', slotId);
            const reader = new FileReader();
            const slot = document.querySelector(`[onclick*="${slotId}"]`);
            
            if (slot) {
                slot.classList.add('uploading');
            }
            
            reader.onload = function(e) {
                const imgElement = document.getElementById(slotId.includes('hero') ? `hero-img-${slotId.split('-')[1]}` : `insta-img-${slotId.split('-')[1]}`);
                console.log('Found image element:', imgElement ? 'yes' : 'no', 'for slot:', slotId);
                
                if (imgElement) {
                    imgElement.src = e.target.result;
                    imgElement.onload = function() {
                        if (slot) {
                            slot.classList.remove('uploading');
                        }
                        showNotification('Image uploaded successfully!', 'success');
                    };
                    imgElement.onerror = function() {
                        if (slot) {
                            slot.classList.remove('uploading');
                        }
                        showNotification('Error loading image. Please try again.', 'error');
                    };
                } else {
                    console.error('Could not find image element for slot:', slotId);
                    if (slot) {
                        slot.classList.remove('uploading');
                    }
                    showNotification('Error: Could not find image slot.', 'error');
                }
            };
            
            reader.onerror = function() {
                if (slot) {
                    slot.classList.remove('uploading');
                }
                showNotification('Error reading file. Please try again.', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        function pasteImage(slotId) {
            if (clipboardImageData) {
                const imgElement = document.getElementById(slotId.includes('hero') ? `hero-img-${slotId.split('-')[1]}` : `insta-img-${slotId.split('-')[1]}`);
                if (imgElement) {
                    imgElement.src = clipboardImageData;
                    showNotification('Image pasted successfully!', 'success');
                }
            } else {
                showNotification('No image in clipboard. Copy an image first!', 'warning');
            }
        }

        function removeImage(slotId) {
            const imgElement = document.getElementById(slotId.includes('hero') ? `hero-img-${slotId.split('-')[1]}` : `insta-img-${slotId.split('-')[1]}`);
            if (imgElement && confirm('Are you sure you want to remove this image?')) {
                imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NzU4NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zNWVtIj5DbGljayB0byB1cGxvYWQ8L3RleHQ+PC9zdmc+';
                showNotification('Image removed successfully!', 'success');
            }
        }

        function editInstagramLink(slotId) {
            const linkInput = document.getElementById(`insta-link-${slotId.split('-')[1]}`);
            const currentLink = linkInput ? linkInput.value : '';
            
            const newLink = prompt('Enter Instagram post URL:', currentLink);
            if (newLink && linkInput) {
                linkInput.value = newLink;
                showNotification('Instagram link updated!', 'success');
            }
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function dropImage(event, slotId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageUpload(files[0], slotId);
            }
        }

        // Copy/Paste Functionality
        document.addEventListener('paste', function(event) {
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        clipboardImageData = e.target.result;
                        showNotification('Image copied to clipboard! Use paste button to apply.', 'info');
                    };
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        });
        
        // Initialize Visual Editor on page load
        function initializeVisualEditor() {
            console.log('Initializing visual editor...');
            
            // Set default layout type
            currentLayoutType = 'featured';
            
            // Test if all required elements are present
            const requiredElements = [
                '[data-field="hero-title"]',
                '[data-field="hero-subtitle"]', 
                '#hero-img-1',
                '#hero-img-2',
                '[data-field="instagram-title"]',
                '[data-field="instagram-subtitle"]',
                '#insta-img-1',
                '#insta-img-2',
                '#insta-img-3', 
                '#insta-img-4',
                '#insta-link-1',
                '#insta-link-2',
                '#insta-link-3',
                '#insta-link-4'
            ];
            
            let foundElements = 0;
            requiredElements.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    foundElements++;
                } else {
                    console.warn('Missing element:', selector);
                }
            });
            
            console.log(`Found ${foundElements}/${requiredElements.length} visual editor elements`);
            
            // Ensure layout type buttons work
            const layoutButtons = document.querySelectorAll('.layout-type[data-layout]');
            console.log(`Found ${layoutButtons.length} layout type buttons`);
            
            layoutButtons.forEach(button => {
                const layoutType = button.getAttribute('data-layout');
                console.log('Setting up layout button:', layoutType);
                
                // Remove any existing event listeners and add fresh ones
                button.removeAttribute('onclick');
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Layout button clicked via event listener:', layoutType);
                    selectLayoutType(layoutType);
                });
            });
            
            // Ensure featured is selected by default
            setTimeout(() => {
                const featuredLayout = document.querySelector('[data-layout="featured"]');
                if (featuredLayout) {
                    if (!featuredLayout.classList.contains('active')) {
                        console.log('Setting featured layout as default active');
                        selectLayoutType('featured');
                    }
                } else {
                    console.error('Featured layout button not found');
                }
                
                console.log('Visual editor initialization complete');
            }, 100);
        }
        
        // Initialize when website-layout section is shown
        const originalShowSection = window.showSection;
        window.showSection = function(sectionName) {
            if (originalShowSection) {
                originalShowSection(sectionName);
            }
            
            if (sectionName === 'website-layout') {
                setTimeout(() => {
                    initializeVisualEditor();
                }, 200);
            }
        };
        
        // Also initialize on page load to ensure variables are ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing global variables...');
            if (typeof currentLayoutType === 'undefined') {
                currentLayoutType = 'featured';
            }
            if (typeof clipboardImageData === 'undefined') {
                clipboardImageData = null;
            }
            console.log('Global variables initialized');
        });
        
        // ===== END VISUAL LAYOUT EDITOR FUNCTIONS =====
    }
    </script>

    <!-- Status Update Popup Modal -->
    <div id="statusPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h3><i class="fas fa-edit"></i> Update Order Status</h3>
                <button class="close-btn" onclick="closeStatusPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <p><strong>Order ID:</strong> <span id="popupOrderId"></span></p>
                <p><strong>Current Status:</strong> <span id="currentStatus"></span></p>
                
                <div class="status-options">
                    <label>Select New Status:</label>
                    <div class="status-grid">
                        <button class="status-option" data-status="confirmed" onclick="selectNewStatus('confirmed')">
                            <i class="fas fa-check"></i>
                            <span>Confirmed</span>
                        </button>
                        <button class="status-option" data-status="processing" onclick="selectNewStatus('processing')">
                            <i class="fas fa-cog"></i>
                            <span>Processing</span>
                        </button>
                        <button class="status-option" data-status="shipped" onclick="selectNewStatus('shipped')">
                            <i class="fas fa-truck"></i>
                            <span>Shipped</span>
                        </button>
                        <button class="status-option" data-status="delivered" onclick="selectNewStatus('delivered')">
                            <i class="fas fa-check-circle"></i>
                            <span>Delivered</span>
                        </button>
                        <button class="status-option status-danger" data-status="cancelled" onclick="selectNewStatus('cancelled')">
                            <i class="fas fa-times-circle"></i>
                            <span>Cancelled</span>
                        </button>
                    </div>
                </div>
                
                <div id="selectedStatus" class="selected-status" style="display: none;">
                    <p><strong>New Status:</strong> <span id="newStatusText"></span></p>
                </div>
            </div>
            <div class="popup-footer">
                <button class="btn-secondary" onclick="closeStatusPopup()">Cancel</button>
                <button id="saveStatusBtn" class="btn-primary" onclick="saveOrderStatus()" style="display: none;">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Deployment History Modal -->
    <div id="deployment-modal" class="deployment-modal">
        <div class="deployment-modal-content">
            <div class="deployment-modal-header">
                <h3><i class="fas fa-history"></i> Deployment History</h3>
                <button class="deployment-modal-close" onclick="closeDeploymentHistory()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="deployment-modal-body">
                <div id="deployment-list" class="deployment-list">
                    <!-- Deployment items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Deployment Confirmation Modal -->
    <div id="deploy-confirmation-modal" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h3><i class="fas fa-rocket"></i> Deploy to Live Website</h3>
                <button class="close-btn" onclick="closeDeployConfirmation()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <p><strong>You're about to deploy your changes to the live website.</strong></p>
                <p>This will make your changes visible to all visitors immediately.</p>
                
                <div id="deploy-changes-summary" class="deployment-changes">
                    <h5>Changes to be deployed:</h5>
                    <ul id="deploy-changes-list" class="changes-list">
                        <!-- Changes will be populated here -->
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="deploy-description">Deployment Description (Optional):</label>
                    <input type="text" id="deploy-description" placeholder="Brief description of changes..." maxlength="200">
                </div>
            </div>
            <div class="popup-footer">
                <button class="btn-secondary" onclick="closeDeployConfirmation()">Cancel</button>
                <button class="btn-success" onclick="confirmDeployment()">
                    <i class="fas fa-rocket"></i> Deploy Now
                </button>
            </div>
        </div>
    </div>

</body>
</html>